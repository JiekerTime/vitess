[
  {
    "comment": "subquery in ON clause, single route",
    "query": "select unsharded_a.col from unsharded_a join unsharded_b on (select col from user)",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select unsharded_a.col from unsharded_a join unsharded_b on (select col from user)",
      "Instructions": {
        "OperatorType": "Subquery",
        "Variant": "PulloutValue",
        "PulloutVars": [
          "__sq1"
        ],
        "Inputs": [
          {
            "InputName": "SubQuery",
            "OperatorType": "Route",
            "Variant": "Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select col from `user` where 1 != 1",
            "Query": "select col from `user`",
            "Table": "`user`"
          },
          {
            "InputName": "Outer",
            "OperatorType": "Route",
            "Variant": "Unsharded",
            "Keyspace": {
              "Name": "main",
              "Sharded": false
            },
            "FieldQuery": "select unsharded_a.col from unsharded_a, unsharded_b where 1 != 1",
            "Query": "select unsharded_a.col from unsharded_a, unsharded_b where :__sq1",
            "Table": "unsharded_a, unsharded_b"
          }
        ]
      },
      "TablesUsed": [
        "main.unsharded_a",
        "main.unsharded_b",
        "user.user"
      ]
    }
  },
  {
    "comment": "subquery in ON clause as sub-expression",
    "query": "select unsharded_a.col from unsharded_a join unsharded_b on unsharded_a.col+(select col from user)",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select unsharded_a.col from unsharded_a join unsharded_b on unsharded_a.col+(select col from user)",
      "Instructions": {
        "OperatorType": "Subquery",
        "Variant": "PulloutValue",
        "PulloutVars": [
          "__sq1"
        ],
        "Inputs": [
          {
            "InputName": "SubQuery",
            "OperatorType": "Route",
            "Variant": "Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select col from `user` where 1 != 1",
            "Query": "select col from `user`",
            "Table": "`user`"
          },
          {
            "InputName": "Outer",
            "OperatorType": "Route",
            "Variant": "Unsharded",
            "Keyspace": {
              "Name": "main",
              "Sharded": false
            },
            "FieldQuery": "select unsharded_a.col from unsharded_a, unsharded_b where 1 != 1",
            "Query": "select unsharded_a.col from unsharded_a, unsharded_b where unsharded_a.col + :__sq1",
            "Table": "unsharded_a, unsharded_b"
          }
        ]
      },
      "TablesUsed": [
        "main.unsharded_a",
        "main.unsharded_b",
        "user.user"
      ]
    }
  },
  {
    "comment": "IN subquery in ON clause, single route",
    "query": "select unsharded_a.col from unsharded_a join unsharded_b on unsharded_a.col in (select col from user)",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select unsharded_a.col from unsharded_a join unsharded_b on unsharded_a.col in (select col from user)",
      "Instructions": {
        "OperatorType": "Subquery",
        "Variant": "PulloutIn",
        "PulloutVars": [
          "__sq_has_values1",
          "__sq1"
        ],
        "Inputs": [
          {
            "InputName": "SubQuery",
            "OperatorType": "Route",
            "Variant": "Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select col from `user` where 1 != 1",
            "Query": "select col from `user`",
            "Table": "`user`"
          },
          {
            "InputName": "Outer",
            "OperatorType": "Route",
            "Variant": "Unsharded",
            "Keyspace": {
              "Name": "main",
              "Sharded": false
            },
            "FieldQuery": "select unsharded_a.col from unsharded_a, unsharded_b where 1 != 1",
            "Query": "select unsharded_a.col from unsharded_a, unsharded_b where :__sq_has_values1 = 1 and unsharded_a.col in ::__sq1",
            "Table": "unsharded_a, unsharded_b"
          }
        ]
      },
      "TablesUsed": [
        "main.unsharded_a",
        "main.unsharded_b",
        "user.user"
      ]
    }
  },
  {
    "comment": "subquery in ON clause, with join primitives",
    "query": "select unsharded.col from unsharded join user on user.col in (select col from user)",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select unsharded.col from unsharded join user on user.col in (select col from user)",
      "Instructions": {
        "OperatorType": "Subquery",
        "Variant": "PulloutIn",
        "PulloutVars": [
          "__sq_has_values1",
          "__sq1"
        ],
        "Inputs": [
          {
            "InputName": "SubQuery",
            "OperatorType": "Route",
            "Variant": "Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select col from `user` where 1 != 1",
            "Query": "select col from `user`",
            "Table": "`user`"
          },
          {
            "InputName": "Outer",
            "OperatorType": "Join",
            "Variant": "Join",
            "JoinColumnIndexes": "L:0",
            "TableName": "unsharded_`user`",
            "Inputs": [
              {
                "OperatorType": "Route",
                "Variant": "Unsharded",
                "Keyspace": {
                  "Name": "main",
                  "Sharded": false
                },
                "FieldQuery": "select unsharded.col from unsharded where 1 != 1",
                "Query": "select unsharded.col from unsharded",
                "Table": "unsharded"
              },
              {
                "OperatorType": "Route",
                "Variant": "Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select 1 from `user` where 1 != 1",
                "Query": "select 1 from `user` where :__sq_has_values1 = 1 and `user`.col in ::__sq1",
                "Table": "`user`"
              }
            ]
          }
        ]
      },
      "TablesUsed": [
        "main.unsharded",
        "user.user"
      ]
    }
  },
  {
    "comment": "subquery in ON clause, with left join primitives\n# The subquery is not pulled all the way out.",
    "query": "select unsharded.col from unsharded left join user on user.col in (select col from user)",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select unsharded.col from unsharded left join user on user.col in (select col from user)",
      "Instructions": {
        "OperatorType": "Subquery",
        "Variant": "PulloutIn",
        "PulloutVars": [
          "__sq_has_values1",
          "__sq1"
        ],
        "Inputs": [
          {
            "InputName": "SubQuery",
            "OperatorType": "Route",
            "Variant": "Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select col from `user` where 1 != 1",
            "Query": "select col from `user`",
            "Table": "`user`"
          },
          {
            "InputName": "Outer",
            "OperatorType": "Join",
            "Variant": "LeftJoin",
            "JoinColumnIndexes": "L:0",
            "TableName": "unsharded_`user`",
            "Inputs": [
              {
                "OperatorType": "Route",
                "Variant": "Unsharded",
                "Keyspace": {
                  "Name": "main",
                  "Sharded": false
                },
                "FieldQuery": "select unsharded.col from unsharded where 1 != 1",
                "Query": "select unsharded.col from unsharded",
                "Table": "unsharded"
              },
              {
                "OperatorType": "Route",
                "Variant": "Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select 1 from `user` where 1 != 1",
                "Query": "select 1 from `user` where :__sq_has_values1 = 1 and `user`.col in ::__sq1",
                "Table": "`user`"
              }
            ]
          }
        ]
      },
      "TablesUsed": [
        "main.unsharded",
        "user.user"
      ]
    }
  },
  {
    "comment": "subquery in ON clause, with join primitives, and join on top\n# The subquery is not pulled all the way out.",
    "query": "select unsharded.col from unsharded join user on user.col in (select col from user) join unsharded_a",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select unsharded.col from unsharded join user on user.col in (select col from user) join unsharded_a",
      "Instructions": {
        "OperatorType": "Subquery",
        "Variant": "PulloutIn",
        "PulloutVars": [
          "__sq_has_values1",
          "__sq1"
        ],
        "Inputs": [
          {
            "InputName": "SubQuery",
            "OperatorType": "Route",
            "Variant": "Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select col from `user` where 1 != 1",
            "Query": "select col from `user`",
            "Table": "`user`"
          },
          {
            "InputName": "Outer",
            "OperatorType": "Join",
            "Variant": "Join",
            "JoinColumnIndexes": "R:0",
            "TableName": "`user`_unsharded, unsharded_a",
            "Inputs": [
              {
                "OperatorType": "Route",
                "Variant": "Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select 1 from `user` where 1 != 1",
                "Query": "select 1 from `user` where :__sq_has_values1 = 1 and `user`.col in ::__sq1",
                "Table": "`user`"
              },
              {
                "OperatorType": "Route",
                "Variant": "Unsharded",
                "Keyspace": {
                  "Name": "main",
                  "Sharded": false
                },
                "FieldQuery": "select unsharded.col from unsharded, unsharded_a where 1 != 1",
                "Query": "select unsharded.col from unsharded, unsharded_a",
                "Table": "unsharded, unsharded_a"
              }
            ]
          }
        ]
      },
      "TablesUsed": [
        "main.unsharded",
        "main.unsharded_a",
        "user.user"
      ]
    }
  }
]