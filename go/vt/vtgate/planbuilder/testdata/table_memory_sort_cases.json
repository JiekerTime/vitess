[
  {
    "comment": "Test cases in this file follow the code in memory_sort.go.\n# scatter aggregate order by references ungrouped column",
    "query": "select a, b, count(*) from t_user group by a order by b",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select a, b, count(*) from t_user group by a order by b",
      "Instructions": {
        "OperatorType": "Sort",
        "Variant": "Memory",
        "OrderBy": "(1|3) ASC",
        "ResultColumns": 3,
        "Inputs": [
          {
            "OperatorType": "Aggregate",
            "Variant": "Ordered",
            "Aggregates": "any_value(1) AS b, sum_count_star(2) AS count(*), any_value(3)",
            "GroupBy": "(0|4)",
            "Inputs": [
              {
                "OperatorType": "TableRoute",
                "Variant": "Scatter-Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select a, b, count(*), weight_string(b), weight_string(a) from t_user_0 where 1 != 1 group by a, weight_string(a)",
                "OrderBy": "(0|4) ASC",
                "Query": "select a, b, count(*), weight_string(b), weight_string(a) from t_user group by a, weight_string(a) order by a asc",
                "Table": "t_user"
              }
            ]
          }
        ]
      },
      "TablesUsed": [
        "user.t_user"
      ]
    }
  },
  {
    "comment": "scatter aggregate order by references aggregate expression",
    "query": "select a, b, count(*) k from t_user group by a order by k",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select a, b, count(*) k from t_user group by a order by k",
      "Instructions": {
        "OperatorType": "Sort",
        "Variant": "Memory",
        "OrderBy": "2 ASC",
        "ResultColumns": 3,
        "Inputs": [
          {
            "OperatorType": "Aggregate",
            "Variant": "Ordered",
            "Aggregates": "any_value(1) AS b, sum_count_star(2) AS k",
            "GroupBy": "(0|3)",
            "Inputs": [
              {
                "OperatorType": "TableRoute",
                "Variant": "Scatter-Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select a, b, count(*) as k, weight_string(a) from t_user_0 where 1 != 1 group by a, weight_string(a)",
                "OrderBy": "(0|3) ASC",
                "Query": "select a, b, count(*) as k, weight_string(a) from t_user group by a, weight_string(a) order by a asc",
                "Table": "t_user"
              }
            ]
          }
        ]
      },
      "TablesUsed": [
        "user.t_user"
      ]
    }
  },
  {
    "comment": "select a, b, count(*) k from t_user group by a order by b, a, k",
    "query": "select a, b, count(*) k from t_user group by a order by b, a, k",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select a, b, count(*) k from t_user group by a order by b, a, k",
      "Instructions": {
        "OperatorType": "Sort",
        "Variant": "Memory",
        "OrderBy": "(1|3) ASC, (0|4) ASC, 2 ASC",
        "ResultColumns": 3,
        "Inputs": [
          {
            "OperatorType": "Aggregate",
            "Variant": "Ordered",
            "Aggregates": "any_value(1) AS b, sum_count_star(2) AS k, any_value(3)",
            "GroupBy": "(0|4)",
            "Inputs": [
              {
                "OperatorType": "TableRoute",
                "Variant": "Scatter-Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select a, b, count(*) as k, weight_string(b), weight_string(a) from t_user_0 where 1 != 1 group by a, weight_string(a)",
                "OrderBy": "(0|4) ASC",
                "Query": "select a, b, count(*) as k, weight_string(b), weight_string(a) from t_user group by a, weight_string(a) order by a asc",
                "Table": "t_user"
              }
            ]
          }
        ]
      },
      "TablesUsed": [
        "user.t_user"
      ]
    }
  },
  {
    "comment": "scatter aggregate with memory sort and limit",
    "query": "select a, b, count(*) k from t_user group by a order by k desc limit 10",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select a, b, count(*) k from t_user group by a order by k desc limit 10",
      "Instructions": {
        "OperatorType": "Limit",
        "Count": "INT64(10)",
        "Inputs": [
          {
            "OperatorType": "Sort",
            "Variant": "Memory",
            "OrderBy": "2 DESC",
            "ResultColumns": 3,
            "Inputs": [
              {
                "OperatorType": "Aggregate",
                "Variant": "Ordered",
                "Aggregates": "any_value(1) AS b, sum_count_star(2) AS k",
                "GroupBy": "(0|3)",
                "Inputs": [
                  {
                    "OperatorType": "TableRoute",
                    "Variant": "Scatter-Scatter",
                    "Keyspace": {
                      "Name": "user",
                      "Sharded": true
                    },
                    "FieldQuery": "select a, b, count(*) as k, weight_string(a) from t_user_0 where 1 != 1 group by a, weight_string(a)",
                    "OrderBy": "(0|3) ASC",
                    "Query": "select a, b, count(*) as k, weight_string(a) from t_user group by a, weight_string(a) order by a asc limit :__upper_limit",
                    "Table": "t_user"
                  }
                ]
              }
            ]
          }
        ]
      },
      "TablesUsed": [
        "user.t_user"
      ]
    }
  },
  {
    "comment": "scatter aggregate with memory sort and order by number",
    "query": "select a, b, count(*) k from t_user group by a order by 1,3",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select a, b, count(*) k from t_user group by a order by 1,3",
      "Instructions": {
        "OperatorType": "Sort",
        "Variant": "Memory",
        "OrderBy": "(0|3) ASC, 2 ASC",
        "ResultColumns": 3,
        "Inputs": [
          {
            "OperatorType": "Aggregate",
            "Variant": "Ordered",
            "Aggregates": "any_value(1) AS b, sum_count_star(2) AS k",
            "GroupBy": "(0|3)",
            "Inputs": [
              {
                "OperatorType": "TableRoute",
                "Variant": "Scatter-Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select a, b, count(*) as k, weight_string(a) from t_user_0 where 1 != 1 group by a, weight_string(a)",
                "OrderBy": "(0|3) ASC",
                "Query": "select a, b, count(*) as k, weight_string(a) from t_user group by a, weight_string(a) order by a asc",
                "Table": "t_user"
              }
            ]
          }
        ]
      },
      "TablesUsed": [
        "user.t_user"
      ]
    }
  },
  {
    "comment": "scatter aggregate with memory sort and order by number, reuse weight_string\n# we have to use a meaningless construct to test this",
    "query": "select textcol1 as t, count(*) k from t_user group by textcol1 order by textcol1, k, textcol1",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select textcol1 as t, count(*) k from t_user group by textcol1 order by textcol1, k, textcol1",
      "Instructions": {
        "OperatorType": "Sort",
        "Variant": "Memory",
        "OrderBy": "0 ASC COLLATE latin1_swedish_ci, 1 ASC",
        "Inputs": [
          {
            "OperatorType": "Aggregate",
            "Variant": "Ordered",
            "Aggregates": "sum_count_star(1) AS k",
            "GroupBy": "0 COLLATE latin1_swedish_ci",
            "Inputs": [
              {
                "OperatorType": "TableRoute",
                "Variant": "Scatter-Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select textcol1 as t, count(*) as k from t_user_0 where 1 != 1 group by textcol1",
                "OrderBy": "0 ASC COLLATE latin1_swedish_ci",
                "Query": "select textcol1 as t, count(*) as k from t_user group by textcol1 order by textcol1 asc",
                "Table": "t_user"
              }
            ]
          }
        ]
      },
      "TablesUsed": [
        "user.t_user"
      ]
    }
  },
  {
    "comment": "unary expression",
    "query": "select a from t_user order by binary a desc",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select a from t_user order by binary a desc",
      "Instructions": {
        "OperatorType": "TableRoute",
        "Variant": "Scatter-Scatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select a, convert(a, binary), weight_string(convert(a, binary)) from t_user_0 where 1 != 1",
        "OrderBy": "(1|2) DESC",
        "Query": "select a, convert(a, binary), weight_string(convert(a, binary)) from t_user order by convert(a, binary) desc",
        "ResultColumns": 1,
        "Table": "t_user"
      },
      "TablesUsed": [
        "user.t_user"
      ]
    }
  },
  {
    "comment": "intcol order by",
    "query": "select id, intcol from t_user order by intcol",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select id, intcol from t_user order by intcol",
      "Instructions": {
        "OperatorType": "TableRoute",
        "Variant": "Scatter-Scatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select id, intcol from t_user_0 where 1 != 1",
        "OrderBy": "1 ASC",
        "Query": "select id, intcol from t_user order by intcol asc",
        "Table": "t_user"
      },
      "TablesUsed": [
        "user.t_user"
      ]
    }
  },
  {
    "comment": "Scatter-Scatter order by with order by column not present",
    "query": "select col from t_user order by id",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select col from t_user order by id",
      "Instructions": {
        "OperatorType": "TableRoute",
        "Variant": "Scatter-Scatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select col, id, weight_string(id) from t_user_0 where 1 != 1",
        "OrderBy": "(1|2) ASC",
        "Query": "select col, id, weight_string(id) from t_user order by id asc",
        "ResultColumns": 1,
        "Table": "t_user"
      },
      "TablesUsed": [
        "user.t_user"
      ]
    }
  },
  {
    "comment": "EqualUnique Select, scatter aggregate order by references ungrouped column",
    "query": "select a, b, count(*) from t_user where id = 1024 group by a order by b",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select a, b, count(*) from t_user where id = 1024 group by a order by b",
      "Instructions": {
        "OperatorType": "Sort",
        "Variant": "Memory",
        "OrderBy": "(1|3) ASC",
        "ResultColumns": 3,
        "Inputs": [
          {
            "OperatorType": "Aggregate",
            "Variant": "Ordered",
            "Aggregates": "any_value(1) AS b, sum_count_star(2) AS count(*), any_value(3)",
            "GroupBy": "(0|4)",
            "Inputs": [
              {
                "OperatorType": "TableRoute",
                "Variant": "EqualUnique-Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select a, b, count(*), weight_string(b), weight_string(a) from t_user_0 where 1 != 1 group by a, weight_string(a)",
                "OrderBy": "(0|4) ASC",
                "Query": "select a, b, count(*), weight_string(b), weight_string(a) from t_user where id = 1024 group by a, weight_string(a) order by a asc",
                "Table": "t_user",
                "Values": [
                  "INT64(1024)"
                ],
                "Vindex": "user_index"
              }
            ]
          }
        ]
      },
      "TablesUsed": [
        "user.t_user"
      ]
    }
  },
  {
    "comment": "scatter aggregate order by references ungrouped column, table index EqualUnique",
    "query": "select a, b, count(*) from t_user where col = 1024 group by a order by b",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select a, b, count(*) from t_user where col = 1024 group by a order by b",
      "Instructions": {
        "OperatorType": "Sort",
        "Variant": "Memory",
        "OrderBy": "(1|3) ASC",
        "ResultColumns": 3,
        "Inputs": [
          {
            "OperatorType": "Aggregate",
            "Variant": "Ordered",
            "Aggregates": "any_value(1) AS b, sum_count_star(2) AS count(*), any_value(3)",
            "GroupBy": "(0|4)",
            "Inputs": [
              {
                "OperatorType": "TableRoute",
                "OrderBy": "(0|4) ASC",
                "Variant": "Scatter-EqualUnique",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select a, b, count(*), weight_string(b), weight_string(a) from t_user_0 where 1 != 1 group by a, weight_string(a)",
                "Query": "select a, b, count(*), weight_string(b), weight_string(a) from t_user where col = 1024 group by a, weight_string(a) order by a asc",
                "Table": "t_user",
                "TableValues": [
                  "INT64(1024)"
                ]
              }
            ]
          }
        ]
      },
      "TablesUsed": [
        "user.t_user"
      ]
    }
  },
  {
    "comment": "vindex EqualUnique, table index EqualUnique",
    "query": "select a, b, count(*) from t_user where col = 1024 and id = 100865 group by a order by b",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select a, b, count(*) from t_user where col = 1024 and id = 100865 group by a order by b",
      "Instructions": {
        "OperatorType": "TableRoute",
        "Variant": "EqualUnique-EqualUnique",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select a, b, count(*) from t_user_0 where 1 != 1 group by a",
        "Query": "select a, b, count(*) from t_user where col = 1024 and id = 100865 group by a order by b asc",
        "Table": "t_user",
        "TableValues": [
          "INT64(1024)"
        ],
        "Values": [
          "INT64(100865)"
        ],
        "Vindex": "user_index"
      },
      "TablesUsed": [
        "user.t_user"
      ]
    }
  },
  {
    "comment": "order by on a cross-shard query. Note: this happens only when an order by column is from the second table",
    "query": "select t_user.col1 as a, t_user.col2 b, t_music.col3 c from t_user, t_music where t_user.id = t_music.id and t_user.id = 1 order by c",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select t_user.col1 as a, t_user.col2 b, t_music.col3 c from t_user, t_music where t_user.id = t_music.id and t_user.id = 1 order by c",
      "Instructions": {
        "OperatorType": "Sort",
        "Variant": "Memory",
        "OrderBy": "(2|3) ASC",
        "ResultColumns": 3,
        "Inputs": [
          {
            "OperatorType": "Join",
            "Variant": "Join",
            "JoinColumnIndexes": "L:0,L:1,R:0,R:1",
            "JoinVars": {
              "t_user_id": 2
            },
            "TableName": "t_user_t_music",
            "Inputs": [
              {
                "OperatorType": "TableRoute",
                "Variant": "EqualUnique-Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select t_user_0.col1 as a, t_user_0.col2 as b, t_user_0.id from t_user_0 where 1 != 1",
                "Query": "select t_user.col1 as a, t_user.col2 as b, t_user.id from t_user where t_user.id = 1",
                "Table": "t_user",
                "Values": [
                  "INT64(1)"
                ],
                "Vindex": "user_index"
              },
              {
                "OperatorType": "TableRoute",
                "Variant": "EqualUnique-Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select t_music_0.col3 as c, weight_string(t_music_0.col3) from t_music_0 where 1 != 1",
                "Query": "select t_music.col3 as c, weight_string(t_music.col3) from t_music where t_music.id = :t_user_id",
                "Table": "t_music",
                "Values": [
                  ":t_user_id"
                ],
                "Vindex": "music_user_map"
              }
            ]
          }
        ]
      },
      "TablesUsed": [
        "user.t_music",
        "user.t_user"
      ]
    }
  },
  {
    "comment": "Order by for join, with mixed cross-shard ordering",
    "query": "select t_user.col1 as a, t_user.col2, t_music.col3 from t_user join t_music on t_user.id = t_music.id where t_user.id = 1 order by 1 asc, 3 desc, 2 asc",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select t_user.col1 as a, t_user.col2, t_music.col3 from t_user join t_music on t_user.id = t_music.id where t_user.id = 1 order by 1 asc, 3 desc, 2 asc",
      "Instructions": {
        "OperatorType": "Sort",
        "Variant": "Memory",
        "OrderBy": "(0|3) ASC, (2|4) DESC, (1|5) ASC",
        "ResultColumns": 3,
        "Inputs": [
          {
            "OperatorType": "Join",
            "Variant": "Join",
            "JoinColumnIndexes": "L:0,L:1,R:0,L:2,R:1,L:3",
            "JoinVars": {
              "t_user_id": 4
            },
            "TableName": "t_user_t_music",
            "Inputs": [
              {
                "OperatorType": "TableRoute",
                "Variant": "EqualUnique-Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select t_user_0.col1 as a, t_user_0.col2, weight_string(t_user_0.col1), weight_string(t_user_0.col2), t_user_0.id from t_user_0 where 1 != 1",
                "Query": "select t_user.col1 as a, t_user.col2, weight_string(t_user.col1), weight_string(t_user.col2), t_user.id from t_user where t_user.id = 1",
                "Table": "t_user",
                "Values": [
                  "INT64(1)"
                ],
                "Vindex": "user_index"
              },
              {
                "OperatorType": "TableRoute",
                "Variant": "EqualUnique-Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select t_music_0.col3, weight_string(t_music_0.col3) from t_music_0 where 1 != 1",
                "Query": "select t_music.col3, weight_string(t_music.col3) from t_music where t_music.id = :t_user_id",
                "Table": "t_music",
                "Values": [
                  ":t_user_id"
                ],
                "Vindex": "music_user_map"
              }
            ]
          }
        ]
      },
      "TablesUsed": [
        "user.t_music",
        "user.t_user"
      ]
    }
  },
  {
    "comment": "unary expression in join query",
    "query": "select u.a from t_user u join t_music m on u.a = m.a order by binary a desc",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select u.a from t_user u join t_music m on u.a = m.a order by binary a desc",
      "Instructions": {
        "OperatorType": "Join",
        "Variant": "Join",
        "JoinColumnIndexes": "L:0",
        "JoinVars": {
          "u_a": 0
        },
        "TableName": "t_user_t_music",
        "Inputs": [
          {
            "OperatorType": "TableRoute",
            "Variant": "Scatter-Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select u.a, convert(a, binary), weight_string(convert(a, binary)) from t_user_0 as u where 1 != 1",
            "OrderBy": "(1|2) DESC",
            "Query": "select u.a, convert(a, binary), weight_string(convert(a, binary)) from t_user as u order by convert(a, binary) desc",
            "Table": "t_user"
          },
          {
            "OperatorType": "TableRoute",
            "Variant": "Scatter-EqualUnique",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select 1 from t_music_0 as m where 1 != 1",
            "Query": "select 1 from t_music as m where m.a = :u_a",
            "TableValues": [
              ":u_a"
            ],
            "Table": "t_music"
          }
        ]
      },
      "TablesUsed": [
        "user.t_music",
        "user.t_user"
      ]
    }
  }
]