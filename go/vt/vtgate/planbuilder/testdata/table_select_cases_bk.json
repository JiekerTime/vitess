[
  {
    "comment": "select with timeout directive sets QueryTimeout in the route",
    "query": "select /*vt+ QUERY_TIMEOUT_MS=1000 */ * from user",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select /*vt+ QUERY_TIMEOUT_MS=1000 */ * from user",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Scatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select * from `user` where 1 != 1",
        "Query": "select /*vt+ QUERY_TIMEOUT_MS=1000 */ * from `user`",
        "QueryTimeout": 1000,
        "Table": "`user`"
      },
      "TablesUsed": [
        "user.user"
      ]
    }
  },
  {
    "comment": "select aggregation with timeout directive sets QueryTimeout in the route",
    "query": "select /*vt+ QUERY_TIMEOUT_MS=1000 */ count(*) from user",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select /*vt+ QUERY_TIMEOUT_MS=1000 */ count(*) from user",
      "Instructions": {
        "OperatorType": "Aggregate",
        "Variant": "Scalar",
        "Aggregates": "sum_count_star(0) AS count(*)",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select count(*) from `user` where 1 != 1",
            "Query": "select /*vt+ QUERY_TIMEOUT_MS=1000 */ count(*) from `user`",
            "QueryTimeout": 1000,
            "Table": "`user`"
          }
        ]
      },
      "TablesUsed": [
        "user.user"
      ]
    }
  },
  {
    "comment": "select limit with timeout directive sets QueryTimeout in the route",
    "query": "select /*vt+ QUERY_TIMEOUT_MS=1000 */ * from user limit 10",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select /*vt+ QUERY_TIMEOUT_MS=1000 */ * from user limit 10",
      "Instructions": {
        "OperatorType": "Limit",
        "Count": "INT64(10)",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select * from `user` where 1 != 1",
            "Query": "select /*vt+ QUERY_TIMEOUT_MS=1000 */ * from `user` limit :__upper_limit",
            "QueryTimeout": 1000,
            "Table": "`user`"
          }
        ]
      },
      "TablesUsed": [
        "user.user"
      ]
    }
  },
  {
    "comment": "select limit with timeout directive sets QueryTimeout in the route",
    "query": "select /*vt+ QUERY_TIMEOUT_MS=1000 */ * from main.unsharded limit 10",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select /*vt+ QUERY_TIMEOUT_MS=1000 */ * from main.unsharded limit 10",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Unsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select * from unsharded where 1 != 1",
        "Query": "select /*vt+ QUERY_TIMEOUT_MS=1000 */ * from unsharded limit 10",
        "QueryTimeout": 1000,
        "Table": "unsharded"
      },
      "TablesUsed": [
        "main.unsharded"
      ]
    }
  },
  {
    "comment": "select with partial scatter directive",
    "query": "select /*vt+ SCATTER_ERRORS_AS_WARNINGS */ * from user",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select /*vt+ SCATTER_ERRORS_AS_WARNINGS */ * from user",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Scatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select * from `user` where 1 != 1",
        "Query": "select /*vt+ SCATTER_ERRORS_AS_WARNINGS */ * from `user`",
        "ScatterErrorsAsWarnings": true,
        "Table": "`user`"
      },
      "TablesUsed": [
        "user.user"
      ]
    }
  },
  {
    "comment": "select aggregation with partial scatter directive",
    "query": "select /*vt+ SCATTER_ERRORS_AS_WARNINGS=1 */ count(*) from user",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select /*vt+ SCATTER_ERRORS_AS_WARNINGS=1 */ count(*) from user",
      "Instructions": {
        "OperatorType": "Aggregate",
        "Variant": "Scalar",
        "Aggregates": "sum_count_star(0) AS count(*)",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select count(*) from `user` where 1 != 1",
            "Query": "select /*vt+ SCATTER_ERRORS_AS_WARNINGS=1 */ count(*) from `user`",
            "ScatterErrorsAsWarnings": true,
            "Table": "`user`"
          }
        ]
      },
      "TablesUsed": [
        "user.user"
      ]
    }
  },
  {
    "comment": "select aggregation with partial scatter directive - added comments to try to confuse the hint extraction",
    "query": "/*VT_SPAN_CONTEXT=123*/select /*vt+ SCATTER_ERRORS_AS_WARNINGS=1 */ count(*) from user",
    "plan": {
      "QueryType": "SELECT",
      "Original": "/*VT_SPAN_CONTEXT=123*/select /*vt+ SCATTER_ERRORS_AS_WARNINGS=1 */ count(*) from user",
      "Instructions": {
        "OperatorType": "Aggregate",
        "Variant": "Scalar",
        "Aggregates": "sum_count_star(0) AS count(*)",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select count(*) from `user` where 1 != 1",
            "Query": "select /*vt+ SCATTER_ERRORS_AS_WARNINGS=1 */ count(*) from `user`",
            "ScatterErrorsAsWarnings": true,
            "Table": "`user`"
          }
        ]
      },
      "TablesUsed": [
        "user.user"
      ]
    }
  },
  {
    "comment": "select limit with partial scatter directive",
    "query": "select /*vt+ SCATTER_ERRORS_AS_WARNINGS=1 */ * from user limit 10",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select /*vt+ SCATTER_ERRORS_AS_WARNINGS=1 */ * from user limit 10",
      "Instructions": {
        "OperatorType": "Limit",
        "Count": "INT64(10)",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select * from `user` where 1 != 1",
            "Query": "select /*vt+ SCATTER_ERRORS_AS_WARNINGS=1 */ * from `user` limit :__upper_limit",
            "ScatterErrorsAsWarnings": true,
            "Table": "`user`"
          }
        ]
      },
      "TablesUsed": [
        "user.user"
      ]
    }
  },
  {
    "comment": "select * from join of authoritative tables",
    "query": "select * from authoritative a join authoritative b on a.user_id=b.user_id",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select * from authoritative a join authoritative b on a.user_id=b.user_id",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Scatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select a.user_id as user_id, a.col1 as col1, a.col2 as col2, b.user_id as user_id, b.col1 as col1, b.col2 as col2 from authoritative as a, authoritative as b where 1 != 1",
        "Query": "select a.user_id as user_id, a.col1 as col1, a.col2 as col2, b.user_id as user_id, b.col1 as col1, b.col2 as col2 from authoritative as a, authoritative as b where a.user_id = b.user_id",
        "Table": "authoritative"
      },
      "TablesUsed": [
        "user.authoritative"
      ]
    }
  },
  {
    "comment": "test table lookup failure for authoritative code path",
    "query": "select a.* from authoritative",
    "plan": "Unknown table 'a'"
  },
  {
    "comment": "select * from intermixing of authoritative table with non-authoritative results in no expansion",
    "query": "select * from authoritative join user on authoritative.user_id=user.id",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select * from authoritative join user on authoritative.user_id=user.id",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Scatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select * from authoritative, `user` where 1 != 1",
        "Query": "select * from authoritative, `user` where authoritative.user_id = `user`.id",
        "Table": "`user`, authoritative"
      },
      "TablesUsed": [
        "user.authoritative",
        "user.user"
      ]
    }
  },
  {
    "comment": "select authoritative.* with intermixing still expands",
    "query": "select user.id, a.*, user.col1 from authoritative a join user on a.user_id=user.id",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select user.id, a.*, user.col1 from authoritative a join user on a.user_id=user.id",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Scatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select `user`.id, a.user_id as user_id, a.col1 as col1, a.col2 as col2, `user`.col1 from authoritative as a, `user` where 1 != 1",
        "Query": "select `user`.id, a.user_id as user_id, a.col1 as col1, a.col2 as col2, `user`.col1 from authoritative as a, `user` where a.user_id = `user`.id",
        "Table": "`user`, authoritative"
      },
      "TablesUsed": [
        "user.authoritative",
        "user.user"
      ]
    }
  },
  {
    "comment": "auto-resolve anonymous columns for simple route",
    "query": "select anon_col from user join user_extra on user.id = user_extra.user_id",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select anon_col from user join user_extra on user.id = user_extra.user_id",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Scatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select anon_col from `user`, user_extra where 1 != 1",
        "Query": "select anon_col from `user`, user_extra where `user`.id = user_extra.user_id",
        "Table": "`user`, user_extra"
      },
      "TablesUsed": [
        "user.user",
        "user.user_extra"
      ]
    }
  },
  {
    "comment": "Cannot auto-resolve for cross-shard joins",
    "query": "select col from user join user_extra",
    "plan": "Column 'col' in field list is ambiguous"
  },
  {
    "comment": "database calls should be substituted",
    "query": "select database() from dual",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select database() from dual",
      "Instructions": {
        "OperatorType": "Projection",
        "Expressions": [
          ":__vtdbname as database()"
        ],
        "Inputs": [
          {
            "OperatorType": "SingleRow"
          }
        ]
      },
      "TablesUsed": [
        "main.dual"
      ]
    }
  },
  {
    "comment": "last_insert_id for unsharded route",
    "query": "select last_insert_id() as x from main.unsharded",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select last_insert_id() as x from main.unsharded",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Unsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select :__lastInsertId as x from unsharded where 1 != 1",
        "Query": "select :__lastInsertId as x from unsharded",
        "Table": "unsharded"
      },
      "TablesUsed": [
        "main.unsharded"
      ]
    }
  },
  {
    "comment": "select from dual on unqualified keyspace",
    "query": "select @@session.auto_increment_increment from dual",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select @@session.auto_increment_increment from dual",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Reference",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select @@auto_increment_increment from dual where 1 != 1",
        "Query": "select @@auto_increment_increment from dual",
        "Table": "dual"
      },
      "TablesUsed": [
        "main.dual"
      ]
    }
  },
  {
    "comment": "select from pinned table",
    "query": "select * from pin_test",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select * from pin_test",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "EqualUnique",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select * from pin_test where 1 != 1",
        "Query": "select * from pin_test",
        "Table": "pin_test",
        "Values": [
          "VARCHAR(\"\\x80\")"
        ],
        "Vindex": "binary"
      },
      "TablesUsed": [
        "user.pin_test"
      ]
    }
  },
  {
    "comment": "prefixing dual with a keyspace should not work",
    "query": "select 1 from user.dual",
    "plan": "table dual not found"
  },
  {
    "comment": "Field query should work for joins select bind vars",
    "query": "select user.id, (select user.id+outm.m+unsharded.m from unsharded) from user join unsharded outm",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select user.id, (select user.id+outm.m+unsharded.m from unsharded) from user join unsharded outm",
      "Instructions": {
        "OperatorType": "Join",
        "Variant": "Join",
        "JoinColumnIndexes": "L:0,R:0",
        "JoinVars": {
          "user_id": 0
        },
        "TableName": "`user`_unsharded",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select `user`.id from `user` where 1 != 1",
            "Query": "select `user`.id from `user`",
            "Table": "`user`"
          },
          {
            "OperatorType": "Route",
            "Variant": "Unsharded",
            "Keyspace": {
              "Name": "main",
              "Sharded": false
            },
            "FieldQuery": "select (select :user_id + outm.m + unsharded.m from unsharded where 1 != 1) from unsharded as outm where 1 != 1",
            "Query": "select (select :user_id + outm.m + unsharded.m from unsharded) from unsharded as outm",
            "Table": "unsharded"
          }
        ]
      },
      "TablesUsed": [
        "main.unsharded",
        "user.user"
      ]
    }
  },
  {
    "comment": "syntax error",
    "query": "the quick brown fox",
    "plan": "syntax error at position 4 near 'the'"
  },
  {
    "comment": "select * from derived table expands specific columns",
    "query": "select * from (select user.id id1, user_extra.id id2 from user join user_extra) as t",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select * from (select user.id id1, user_extra.id id2 from user join user_extra) as t",
      "Instructions": {
        "OperatorType": "Join",
        "Variant": "Join",
        "JoinColumnIndexes": "L:0,R:0",
        "TableName": "`user`_user_extra",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select t.id1 from (select `user`.id as id1 from `user` where 1 != 1) as t where 1 != 1",
            "Query": "select t.id1 from (select `user`.id as id1 from `user`) as t",
            "Table": "`user`"
          },
          {
            "OperatorType": "Route",
            "Variant": "Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select t.id2 from (select user_extra.id as id2 from user_extra where 1 != 1) as t where 1 != 1",
            "Query": "select t.id2 from (select user_extra.id as id2 from user_extra) as t",
            "Table": "user_extra"
          }
        ]
      },
      "TablesUsed": [
        "user.user",
        "user.user_extra"
      ]
    }
  },
  {
    "comment": "duplicate columns not allowed in derived table",
    "query": "select * from (select user.id, user_extra.id from user join user_extra) as t",
    "plan": "Duplicate column name 'id'"
  },
  {
    "comment": "non-existent symbol in cross-shard derived table",
    "query": "select t.col from (select user.id from user join user_extra) as t",
    "plan": "column 't.col' not found"
  },
  {
    "comment": "union with the same target shard",
    "query": "select * from music where user_id = 1 union select * from user where id = 1",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select * from music where user_id = 1 union select * from user where id = 1",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "EqualUnique",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select * from music where 1 != 1 union select * from `user` where 1 != 1",
        "Query": "select * from music where user_id = 1 union select * from `user` where id = 1",
        "Table": "`user`, music",
        "Values": [
          "INT64(1)"
        ],
        "Vindex": "user_index"
      },
      "TablesUsed": [
        "user.music",
        "user.user"
      ]
    }
  },
  {
    "comment": "union with the same target shard last_insert_id",
    "query": "select *, last_insert_id() from music where user_id = 1 union select * from user where id = 1",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select *, last_insert_id() from music where user_id = 1 union select * from user where id = 1",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "EqualUnique",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select *, :__lastInsertId as `last_insert_id()` from music where 1 != 1 union select * from `user` where 1 != 1",
        "Query": "select *, :__lastInsertId as `last_insert_id()` from music where user_id = 1 union select * from `user` where id = 1",
        "Table": "`user`, music",
        "Values": [
          "INT64(1)"
        ],
        "Vindex": "user_index"
      },
      "TablesUsed": [
        "user.music",
        "user.user"
      ]
    }
  },
  {
    "comment": "unsharded union in derived table",
    "query": "select * from (select col1, col2 from unsharded where id = 1 union select col1, col2 from unsharded where id = 3) a",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select * from (select col1, col2 from unsharded where id = 1 union select col1, col2 from unsharded where id = 3) a",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Unsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select a.col1, a.col2 from (select col1, col2 from unsharded where 1 != 1 union select col1, col2 from unsharded where 1 != 1) as a where 1 != 1",
        "Query": "select a.col1, a.col2 from (select col1, col2 from unsharded where id = 1 union select col1, col2 from unsharded where id = 3) as a",
        "Table": "unsharded"
      },
      "TablesUsed": [
        "main.unsharded"
      ]
    }
  },
  {
    "comment": "(select id from unsharded) union (select id from unsharded_auto) order by id limit 5",
    "query": "(select id from unsharded) union (select id from unsharded_auto) order by id limit 5",
    "plan": {
      "QueryType": "SELECT",
      "Original": "(select id from unsharded) union (select id from unsharded_auto) order by id limit 5",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Unsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select id from unsharded where 1 != 1 union select id from unsharded_auto where 1 != 1",
        "Query": "select id from unsharded union select id from unsharded_auto order by id asc limit 5",
        "Table": "unsharded, unsharded_auto"
      },
      "TablesUsed": [
        "main.unsharded",
        "main.unsharded_auto"
      ]
    }
  },
  {
    "comment": "unsharded union",
    "query": "select id from unsharded union select id from unsharded_auto union select id from unsharded_auto where id in (132)",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select id from unsharded union select id from unsharded_auto union select id from unsharded_auto where id in (132)",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Unsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select id from unsharded where 1 != 1 union select id from unsharded_auto where 1 != 1 union select id from unsharded_auto where 1 != 1",
        "Query": "select id from unsharded union select id from unsharded_auto union select id from unsharded_auto where id in (132)",
        "Table": "unsharded, unsharded_auto"
      },
      "TablesUsed": [
        "main.unsharded",
        "main.unsharded_auto"
      ]
    }
  },
  {
    "comment": "unsharded nested union",
    "query": "(select id from unsharded union select id from unsharded_auto) union (select id from unsharded_auto union select name from unsharded)",
    "plan": {
      "QueryType": "SELECT",
      "Original": "(select id from unsharded union select id from unsharded_auto) union (select id from unsharded_auto union select name from unsharded)",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Unsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select id from unsharded where 1 != 1 union select id from unsharded_auto where 1 != 1 union select id from unsharded_auto where 1 != 1 union select `name` from unsharded where 1 != 1",
        "Query": "select id from unsharded union select id from unsharded_auto union select id from unsharded_auto union select `name` from unsharded",
        "Table": "unsharded, unsharded_auto"
      },
      "TablesUsed": [
        "main.unsharded",
        "main.unsharded_auto"
      ]
    }
  },
  {
    "comment": "unsharded nested union with limit",
    "query": "(select id from unsharded order by id asc limit 1) union (select id from unsharded order by id desc limit 1) order by id asc limit 1",
    "plan": {
      "QueryType": "SELECT",
      "Original": "(select id from unsharded order by id asc limit 1) union (select id from unsharded order by id desc limit 1) order by id asc limit 1",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Unsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "(select id from unsharded where 1 != 1) union (select id from unsharded where 1 != 1)",
        "Query": "(select id from unsharded order by id asc limit 1) union (select id from unsharded order by id desc limit 1) order by id asc limit 1",
        "Table": "unsharded"
      },
      "TablesUsed": [
        "main.unsharded"
      ]
    }
  },
  {
    "comment": "routing rules: ensure directives are not lost",
    "query": "select /*vt+ QUERY_TIMEOUT_MS=1000 */ * from route2",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select /*vt+ QUERY_TIMEOUT_MS=1000 */ * from route2",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Unsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select * from unsharded as route2 where 1 != 1",
        "Query": "select /*vt+ QUERY_TIMEOUT_MS=1000 */ * from unsharded as route2",
        "QueryTimeout": 1000,
        "Table": "unsharded"
      },
      "TablesUsed": [
        "main.unsharded"
      ]
    }
  },
  {
    "comment": "testing SingleRow Projection",
    "query": "select 42",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select 42",
      "Instructions": {
        "OperatorType": "Projection",
        "Expressions": [
          "INT64(42) as 42"
        ],
        "Inputs": [
          {
            "OperatorType": "SingleRow"
          }
        ]
      },
      "TablesUsed": [
        "main.dual"
      ]
    }
  },
  {
    "comment": "don't filter on the vtgate",
    "query": "select 42 from dual where false",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select 42 from dual where false",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "None",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select 42 from dual where 1 != 1",
        "Query": "select 42 from dual where false",
        "Table": "dual"
      },
      "TablesUsed": [
        "main.dual"
      ]
    }
  },
  {
    "comment": "testing SingleRow Projection with arithmetics",
    "query": "select 42+2",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select 42+2",
      "Instructions": {
        "OperatorType": "Projection",
        "Expressions": [
          "INT64(44) as 42 + 2"
        ],
        "Inputs": [
          {
            "OperatorType": "SingleRow"
          }
        ]
      },
      "TablesUsed": [
        "main.dual"
      ]
    }
  },
  {
    "comment": "sql_calc_found_rows without limit",
    "query": "select sql_calc_found_rows * from music where user_id = 1",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select sql_calc_found_rows * from music where user_id = 1",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "EqualUnique",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select * from music where 1 != 1",
        "Query": "select * from music where user_id = 1",
        "Table": "music",
        "Values": [
          "INT64(1)"
        ],
        "Vindex": "user_index"
      },
      "TablesUsed": [
        "user.music"
      ]
    }
  },
  {
    "comment": "sql_calc_found_rows with limit",
    "query": "select sql_calc_found_rows * from music limit 100",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select sql_calc_found_rows * from music limit 100",
      "Instructions": {
        "OperatorType": "SQL_CALC_FOUND_ROWS",
        "Inputs": [
          {
            "OperatorType": "Limit",
            "Count": "INT64(100)",
            "Inputs": [
              {
                "OperatorType": "Route",
                "Variant": "Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select * from music where 1 != 1",
                "Query": "select * from music limit :__upper_limit",
                "Table": "music"
              }
            ]
          },
          {
            "OperatorType": "Aggregate",
            "Variant": "Scalar",
            "Aggregates": "sum_count_star(0) AS count(*)",
            "Inputs": [
              {
                "OperatorType": "Route",
                "Variant": "Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select count(*) from music where 1 != 1",
                "Query": "select count(*) from music",
                "Table": "music"
              }
            ]
          }
        ]
      },
      "TablesUsed": [
        "user.music"
      ]
    }
  },
  {
    "comment": "sql_calc_found_rows with SelectEqualUnique plans",
    "query": "select sql_calc_found_rows * from music where user_id = 1 limit 2",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select sql_calc_found_rows * from music where user_id = 1 limit 2",
      "Instructions": {
        "OperatorType": "SQL_CALC_FOUND_ROWS",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "EqualUnique",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select * from music where 1 != 1",
            "Query": "select * from music where user_id = 1 limit 2",
            "Table": "music",
            "Values": [
              "INT64(1)"
            ],
            "Vindex": "user_index"
          },
          {
            "OperatorType": "Route",
            "Variant": "EqualUnique",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select count(*) from music where 1 != 1",
            "Query": "select count(*) from music where user_id = 1",
            "Table": "music",
            "Values": [
              "INT64(1)"
            ],
            "Vindex": "user_index"
          }
        ]
      },
      "TablesUsed": [
        "user.music"
      ]
    }
  },
  {
    "comment": "sql_calc_found_rows with group by and having",
    "query": "select sql_calc_found_rows user_id, count(id) from music group by user_id having count(user_id) = 1 order by user_id limit 2",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select sql_calc_found_rows user_id, count(id) from music group by user_id having count(user_id) = 1 order by user_id limit 2",
      "Instructions": {
        "OperatorType": "SQL_CALC_FOUND_ROWS",
        "Inputs": [
          {
            "OperatorType": "Limit",
            "Count": "INT64(2)",
            "Inputs": [
              {
                "OperatorType": "Route",
                "Variant": "Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select user_id, count(id), weight_string(user_id) from music where 1 != 1 group by user_id",
                "OrderBy": "(0|2) ASC",
                "Query": "select user_id, count(id), weight_string(user_id) from music group by user_id having count(user_id) = 1 order by user_id asc limit :__upper_limit",
                "ResultColumns": 2,
                "Table": "music"
              }
            ]
          },
          {
            "OperatorType": "Aggregate",
            "Variant": "Scalar",
            "Aggregates": "sum_count_star(0) AS count(*)",
            "Inputs": [
              {
                "OperatorType": "Route",
                "Variant": "Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select count(*) from (select user_id, count(id) from music where 1 != 1 group by user_id) as t where 1 != 1",
                "Query": "select count(*) from (select user_id, count(id) from music group by user_id having count(user_id) = 1) as t",
                "Table": "music"
              }
            ]
          }
        ]
      },
      "TablesUsed": [
        "user.music"
      ]
    }
  },
  {
    "comment": "sql_calc_found_rows in sub queries",
    "query": "select * from music where user_id IN (select sql_calc_found_rows * from music limit 10)",
    "plan": "Incorrect usage/placement of 'SQL_CALC_FOUND_ROWS'"
  },
  {
    "comment": "sql_calc_found_rows in derived table",
    "query": "select sql_calc_found_rows * from (select sql_calc_found_rows * from music limit 10) t limit 1",
    "plan": "Incorrect usage/placement of 'SQL_CALC_FOUND_ROWS'"
  },
  {
    "comment": "select from unsharded keyspace into dumpfile",
    "query": "select * from main.unsharded into Dumpfile 'x.txt'",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select * from main.unsharded into Dumpfile 'x.txt'",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Unsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select * from unsharded where 1 != 1",
        "Query": "select * from unsharded into dumpfile 'x.txt'",
        "Table": "unsharded"
      },
      "TablesUsed": [
        "main.unsharded"
      ]
    }
  },
  {
    "comment": "select from unsharded keyspace into outfile",
    "query": "select * from main.unsharded into outfile 'x.txt' character set binary fields terminated by 'term' optionally enclosed by 'c' escaped by 'e' lines starting by 'a' terminated by '\n'",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select * from main.unsharded into outfile 'x.txt' character set binary fields terminated by 'term' optionally enclosed by 'c' escaped by 'e' lines starting by 'a' terminated by '\n'",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Unsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select * from unsharded where 1 != 1",
        "Query": "select * from unsharded into outfile 'x.txt' character set binary fields terminated by 'term' optionally enclosed by 'c' escaped by 'e' lines starting by 'a' terminated by '\\n'",
        "Table": "unsharded"
      },
      "TablesUsed": [
        "main.unsharded"
      ]
    }
  },
  {
    "comment": "select from unsharded keyspace into outfile s3",
    "query": "select * from main.unsharded into outfile s3 'out_file_name' character set binary format csv header fields terminated by 'term' optionally enclosed by 'c' escaped by 'e' lines starting by 'a' terminated by '\n' manifest on overwrite off",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select * from main.unsharded into outfile s3 'out_file_name' character set binary format csv header fields terminated by 'term' optionally enclosed by 'c' escaped by 'e' lines starting by 'a' terminated by '\n' manifest on overwrite off",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Unsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select * from unsharded where 1 != 1",
        "Query": "select * from unsharded into outfile s3 'out_file_name' character set binary format csv header fields terminated by 'term' optionally enclosed by 'c' escaped by 'e' lines starting by 'a' terminated by '\\n' manifest on overwrite off",
        "Table": "unsharded"
      },
      "TablesUsed": [
        "main.unsharded"
      ]
    }
  },
  {
    "comment": "Union after into outfile is incorrect",
    "query": "select id from user into outfile 'out_file_name' union all select id from music",
    "plan": "syntax error at position 55 near 'union'"
  },
  {
    "comment": "Into outfile s3 in derived table is incorrect",
    "query": "select id from (select id from user into outfile s3 'inner_outfile') as t2",
    "plan": "syntax error at position 41 near 'into'"
  },
  {
    "comment": "Into outfile s3 in derived table with union incorrect",
    "query": "select id from (select id from user into outfile s3 'inner_outfile' union select 1) as t2",
    "plan": "syntax error at position 41 near 'into'"
  },
  {
    "comment": "select (select u.id from user as u where u.id = 1), a.id from user as a where a.id = 1",
    "query": "select (select u.id from user as u where u.id = 1), a.id from user as a where a.id = 1",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select (select u.id from user as u where u.id = 1), a.id from user as a where a.id = 1",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "EqualUnique",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select (select u.id from `user` as u where 1 != 1), a.id from `user` as a where 1 != 1",
        "Query": "select (select u.id from `user` as u where u.id = 1), a.id from `user` as a where a.id = 1",
        "Table": "`user`",
        "Values": [
          "INT64(1)"
        ],
        "Vindex": "user_index"
      },
      "TablesUsed": [
        "user.user"
      ]
    }
  },
  {
    "comment": "Add two tables with the same column in a join",
    "query": "select t.id, s.id from user t join user_extra s on t.id = s.user_id join unsharded",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select t.id, s.id from user t join user_extra s on t.id = s.user_id join unsharded",
      "Instructions": {
        "OperatorType": "Join",
        "Variant": "Join",
        "JoinColumnIndexes": "R:0,R:1",
        "TableName": "unsharded_`user`, user_extra",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "Unsharded",
            "Keyspace": {
              "Name": "main",
              "Sharded": false
            },
            "FieldQuery": "select 1 from unsharded where 1 != 1",
            "Query": "select 1 from unsharded",
            "Table": "unsharded"
          },
          {
            "OperatorType": "Route",
            "Variant": "Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select t.id, s.id from `user` as t, user_extra as s where 1 != 1",
            "Query": "select t.id, s.id from `user` as t, user_extra as s where t.id = s.user_id",
            "Table": "`user`, user_extra"
          }
        ]
      },
      "TablesUsed": [
        "main.unsharded",
        "user.user",
        "user.user_extra"
      ]
    }
  },
  {
    "comment": "((((select 1))))",
    "query": "((((select 1))))",
    "plan": {
      "QueryType": "SELECT",
      "Original": "((((select 1))))",
      "Instructions": {
        "OperatorType": "Projection",
        "Expressions": [
          "INT64(1) as 1"
        ],
        "Inputs": [
          {
            "OperatorType": "SingleRow"
          }
        ]
      },
      "TablesUsed": [
        "main.dual"
      ]
    }
  },
  {
    "comment": "plan test for a natural character set string",
    "query": "select N'string' from dual",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select N'string' from dual",
      "Instructions": {
        "OperatorType": "Projection",
        "Expressions": [
          "VARCHAR(\"string\") as N'string'"
        ],
        "Inputs": [
          {
            "OperatorType": "SingleRow"
          }
        ]
      },
      "TablesUsed": [
        "main.dual"
      ]
    }
  },
  {
    "comment": "union as a derived table",
    "query": "select found from (select id as found from user union all (select id from unsharded)) as t",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select found from (select id as found from user union all (select id from unsharded)) as t",
      "Instructions": {
        "OperatorType": "Concatenate",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select id as found from `user` where 1 != 1",
            "Query": "select id as found from `user`",
            "Table": "`user`"
          },
          {
            "OperatorType": "Route",
            "Variant": "Unsharded",
            "Keyspace": {
              "Name": "main",
              "Sharded": false
            },
            "FieldQuery": "select id from unsharded where 1 != 1",
            "Query": "select id from unsharded",
            "Table": "unsharded"
          }
        ]
      },
      "TablesUsed": [
        "main.unsharded",
        "user.user"
      ]
    }
  },
  {
    "comment": "mergeable derived table with order by and limit",
    "query": "select 1 from (select col from main.unsharded order by main.unsharded.col1 desc limit 12 offset 0) as f left join unsharded as u on f.col = u.id",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select 1 from (select col from main.unsharded order by main.unsharded.col1 desc limit 12 offset 0) as f left join unsharded as u on f.col = u.id",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Unsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select 1 from (select col from unsharded where 1 != 1) as f left join unsharded as u on f.col = u.id where 1 != 1",
        "Query": "select 1 from (select col from unsharded order by unsharded.col1 desc limit 0, 12) as f left join unsharded as u on f.col = u.id",
        "Table": "unsharded"
      },
      "TablesUsed": [
        "main.unsharded"
      ]
    }
  },
  {
    "comment": "mergeable derived table with group by and limit",
    "query": "select 1 from (select col, count(*) as a from main.unsharded group by col having a > 0 limit 12 offset 0) as f left join unsharded as u on f.col = u.id",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select 1 from (select col, count(*) as a from main.unsharded group by col having a > 0 limit 12 offset 0) as f left join unsharded as u on f.col = u.id",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Unsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select 1 from (select col, count(*) as a from unsharded where 1 != 1 group by col) as f left join unsharded as u on f.col = u.id where 1 != 1",
        "Query": "select 1 from (select col, count(*) as a from unsharded group by col having count(*) > 0 limit 0, 12) as f left join unsharded as u on f.col = u.id",
        "Table": "unsharded"
      },
      "TablesUsed": [
        "main.unsharded"
      ]
    }
  },
  {
    "comment": "dual query with exists clause",
    "query": "select 1 from dual where exists (select 1 from information_schema.TABLES where information_schema.TABLES.TABLE_NAME = 'proc' and information_schema.TABLES.TABLE_SCHEMA = 'mysql')",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select 1 from dual where exists (select 1 from information_schema.TABLES where information_schema.TABLES.TABLE_NAME = 'proc' and information_schema.TABLES.TABLE_SCHEMA = 'mysql')",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "DBA",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select 1 from dual where 1 != 1",
        "Query": "select 1 from dual where exists (select 1 from information_schema.`TABLES` where `TABLES`.TABLE_NAME = :TABLES_TABLE_NAME /* VARCHAR */ and `TABLES`.TABLE_SCHEMA = :__vtschemaname /* VARCHAR */ limit 1)",
        "SysTableTableName": "[TABLES_TABLE_NAME:VARCHAR(\"proc\")]",
        "SysTableTableSchema": "[VARCHAR(\"mysql\")]",
        "Table": "dual"
      },
      "TablesUsed": [
        "main.dual"
      ]
    }
  },
  {
    "comment": "json_quote, json_object and json_array",
    "query": "SELECT JSON_QUOTE('null'), JSON_QUOTE('\"null\"'), JSON_OBJECT(BIN(1),2,'abc',ASCII(4)), JSON_ARRAY(1, \"abc\", NULL, TRUE, CURTIME())",
    "plan": {
      "QueryType": "SELECT",
      "Original": "SELECT JSON_QUOTE('null'), JSON_QUOTE('\"null\"'), JSON_OBJECT(BIN(1),2,'abc',ASCII(4)), JSON_ARRAY(1, \"abc\", NULL, TRUE, CURTIME())",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Reference",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select json_quote('null'), json_quote('\\\"null\\\"'), json_object(BIN(1), 2, 'abc', ASCII(4)), json_array(1, 'abc', null, true, curtime()) from dual where 1 != 1",
        "Query": "select json_quote('null'), json_quote('\\\"null\\\"'), json_object(BIN(1), 2, 'abc', ASCII(4)), json_array(1, 'abc', null, true, curtime()) from dual",
        "Table": "dual"
      },
      "TablesUsed": [
        "main.dual"
      ]
    }
  },
  {
    "comment": "yeah, it does not make sense, but it's valid",
    "query": "select exists(select 1) from user where id = 5",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select exists(select 1) from user where id = 5",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "EqualUnique",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select exists (select 1 from dual where 1 != 1) from `user` where 1 != 1",
        "Query": "select exists (select 1 from dual limit 1) from `user` where id = 5",
        "Table": "`user`",
        "Values": [
          "INT64(5)"
        ],
        "Vindex": "user_index"
      },
      "TablesUsed": [
        "main.dual",
        "user.user"
      ]
    }
  },
  {
    "comment": "json schema validation functions",
    "query": "SELECT JSON_SCHEMA_VALID('{\"type\":\"string\",\"pattern\":\"(\"}', '\"abc\"'), JSON_SCHEMA_VALIDATION_REPORT('{\"type\":\"string\",\"pattern\":\"(\"}', '\"abc\"')",
    "plan": {
      "QueryType": "SELECT",
      "Original": "SELECT JSON_SCHEMA_VALID('{\"type\":\"string\",\"pattern\":\"(\"}', '\"abc\"'), JSON_SCHEMA_VALIDATION_REPORT('{\"type\":\"string\",\"pattern\":\"(\"}', '\"abc\"')",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Reference",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select json_schema_valid('{\\\"type\\\":\\\"string\\\",\\\"pattern\\\":\\\"(\\\"}', '\\\"abc\\\"'), json_schema_validation_report('{\\\"type\\\":\\\"string\\\",\\\"pattern\\\":\\\"(\\\"}', '\\\"abc\\\"') from dual where 1 != 1",
        "Query": "select json_schema_valid('{\\\"type\\\":\\\"string\\\",\\\"pattern\\\":\\\"(\\\"}', '\\\"abc\\\"'), json_schema_validation_report('{\\\"type\\\":\\\"string\\\",\\\"pattern\\\":\\\"(\\\"}', '\\\"abc\\\"') from dual",
        "Table": "dual"
      },
      "TablesUsed": [
        "main.dual"
      ]
    }
  },
  {
    "comment": "json search functions",
    "query": "SELECT JSON_CONTAINS('{\"a\": 1, \"b\": 2, \"c\": {\"d\": 4}}', '1'), JSON_CONTAINS_PATH('{\"a\": 1, \"b\": 2, \"c\": {\"d\": 4}}', 'one', '$.a', '$.e'), JSON_EXTRACT('[10, 20, [30, 40]]', '$[1]'), JSON_UNQUOTE(JSON_EXTRACT('[\"a\",\"b\"]', '$[1]')), JSON_KEYS('{\"a\": 1, \"b\": {\"c\": 30}}'), JSON_OVERLAPS(\"[1,3,5,7]\", \"[2,5,7]\"), JSON_SEARCH('[\"abc\"]', 'one', 'abc'), JSON_VALUE('{\"fname\": \"Joe\", \"lname\": \"Palmer\"}', '$.fname'), JSON_ARRAY(4,5) MEMBER OF('[[3,4],[4,5]]')",
    "plan": {
      "QueryType": "SELECT",
      "Original": "SELECT JSON_CONTAINS('{\"a\": 1, \"b\": 2, \"c\": {\"d\": 4}}', '1'), JSON_CONTAINS_PATH('{\"a\": 1, \"b\": 2, \"c\": {\"d\": 4}}', 'one', '$.a', '$.e'), JSON_EXTRACT('[10, 20, [30, 40]]', '$[1]'), JSON_UNQUOTE(JSON_EXTRACT('[\"a\",\"b\"]', '$[1]')), JSON_KEYS('{\"a\": 1, \"b\": {\"c\": 30}}'), JSON_OVERLAPS(\"[1,3,5,7]\", \"[2,5,7]\"), JSON_SEARCH('[\"abc\"]', 'one', 'abc'), JSON_VALUE('{\"fname\": \"Joe\", \"lname\": \"Palmer\"}', '$.fname'), JSON_ARRAY(4,5) MEMBER OF('[[3,4],[4,5]]')",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Reference",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select json_contains('{\\\"a\\\": 1, \\\"b\\\": 2, \\\"c\\\": {\\\"d\\\": 4}}', '1'), json_contains_path('{\\\"a\\\": 1, \\\"b\\\": 2, \\\"c\\\": {\\\"d\\\": 4}}', 'one', '$.a', '$.e'), json_extract('[10, 20, [30, 40]]', '$[1]'), json_unquote(json_extract('[\\\"a\\\",\\\"b\\\"]', '$[1]')), json_keys('{\\\"a\\\": 1, \\\"b\\\": {\\\"c\\\": 30}}'), json_overlaps('[1,3,5,7]', '[2,5,7]'), json_search('[\\\"abc\\\"]', 'one', 'abc'), json_value('{\\\"fname\\\": \\\"Joe\\\", \\\"lname\\\": \\\"Palmer\\\"}', '$.fname'), json_array(4, 5) member of ('[[3,4],[4,5]]') from dual where 1 != 1",
        "Query": "select json_contains('{\\\"a\\\": 1, \\\"b\\\": 2, \\\"c\\\": {\\\"d\\\": 4}}', '1'), json_contains_path('{\\\"a\\\": 1, \\\"b\\\": 2, \\\"c\\\": {\\\"d\\\": 4}}', 'one', '$.a', '$.e'), json_extract('[10, 20, [30, 40]]', '$[1]'), json_unquote(json_extract('[\\\"a\\\",\\\"b\\\"]', '$[1]')), json_keys('{\\\"a\\\": 1, \\\"b\\\": {\\\"c\\\": 30}}'), json_overlaps('[1,3,5,7]', '[2,5,7]'), json_search('[\\\"abc\\\"]', 'one', 'abc'), json_value('{\\\"fname\\\": \\\"Joe\\\", \\\"lname\\\": \\\"Palmer\\\"}', '$.fname'), json_array(4, 5) member of ('[[3,4],[4,5]]') from dual",
        "Table": "dual"
      },
      "TablesUsed": [
        "main.dual"
      ]
    }
  },
  {
    "comment": "Functions that return JSON value attributes",
    "query": "select JSON_DEPTH('{}'), JSON_LENGTH('{\"a\": 1, \"b\": {\"c\": 30}}', '$.b'), JSON_TYPE(JSON_EXTRACT('{\"a\": [10, true]}', '$.a')), JSON_VALID('{\"a\": 1}')",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select JSON_DEPTH('{}'), JSON_LENGTH('{\"a\": 1, \"b\": {\"c\": 30}}', '$.b'), JSON_TYPE(JSON_EXTRACT('{\"a\": [10, true]}', '$.a')), JSON_VALID('{\"a\": 1}')",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Reference",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select json_depth('{}'), json_length('{\\\"a\\\": 1, \\\"b\\\": {\\\"c\\\": 30}}', '$.b'), json_type(json_extract('{\\\"a\\\": [10, true]}', '$.a')), json_valid('{\\\"a\\\": 1}') from dual where 1 != 1",
        "Query": "select json_depth('{}'), json_length('{\\\"a\\\": 1, \\\"b\\\": {\\\"c\\\": 30}}', '$.b'), json_type(json_extract('{\\\"a\\\": [10, true]}', '$.a')), json_valid('{\\\"a\\\": 1}') from dual",
        "Table": "dual"
      },
      "TablesUsed": [
        "main.dual"
      ]
    }
  },
  {
    "comment": "Json array functions",
    "query": "select JSON_ARRAY_APPEND('{\"a\": 1}', '$', 'z'), JSON_ARRAY_INSERT('[\"a\", {\"b\": [1, 2]}, [3, 4]]', '$[0]', 'x', '$[2][1]', 'y'), JSON_INSERT('{ \"a\": 1, \"b\": [2, 3]}', '$.a', 10, '$.c', CAST('[true, false]' AS JSON))",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select JSON_ARRAY_APPEND('{\"a\": 1}', '$', 'z'), JSON_ARRAY_INSERT('[\"a\", {\"b\": [1, 2]}, [3, 4]]', '$[0]', 'x', '$[2][1]', 'y'), JSON_INSERT('{ \"a\": 1, \"b\": [2, 3]}', '$.a', 10, '$.c', CAST('[true, false]' AS JSON))",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Reference",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select json_array_append('{\\\"a\\\": 1}', '$', 'z'), json_array_insert('[\\\"a\\\", {\\\"b\\\": [1, 2]}, [3, 4]]', '$[0]', 'x', '$[2][1]', 'y'), json_insert('{ \\\"a\\\": 1, \\\"b\\\": [2, 3]}', '$.a', 10, '$.c', cast('[true, false]' as JSON)) from dual where 1 != 1",
        "Query": "select json_array_append('{\\\"a\\\": 1}', '$', 'z'), json_array_insert('[\\\"a\\\", {\\\"b\\\": [1, 2]}, [3, 4]]', '$[0]', 'x', '$[2][1]', 'y'), json_insert('{ \\\"a\\\": 1, \\\"b\\\": [2, 3]}', '$.a', 10, '$.c', cast('[true, false]' as JSON)) from dual",
        "Table": "dual"
      },
      "TablesUsed": [
        "main.dual"
      ]
    }
  },
  {
    "comment": "Json merge functions",
    "query": "select JSON_MERGE('[1, 2]', '[true, false]'), JSON_MERGE_PATCH('{\"name\": \"x\"}', '{\"id\": 47}'), JSON_MERGE_PRESERVE('[1, 2]', '{\"id\": 47}')",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select JSON_MERGE('[1, 2]', '[true, false]'), JSON_MERGE_PATCH('{\"name\": \"x\"}', '{\"id\": 47}'), JSON_MERGE_PRESERVE('[1, 2]', '{\"id\": 47}')",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Reference",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select json_merge('[1, 2]', '[true, false]'), json_merge_patch('{\\\"name\\\": \\\"x\\\"}', '{\\\"id\\\": 47}'), json_merge_preserve('[1, 2]', '{\\\"id\\\": 47}') from dual where 1 != 1",
        "Query": "select json_merge('[1, 2]', '[true, false]'), json_merge_patch('{\\\"name\\\": \\\"x\\\"}', '{\\\"id\\\": 47}'), json_merge_preserve('[1, 2]', '{\\\"id\\\": 47}') from dual",
        "Table": "dual"
      },
      "TablesUsed": [
        "main.dual"
      ]
    }
  },
  {
    "comment": "JSON modifier functions",
    "query": "select JSON_REMOVE('[1, [2, 3], 4]', '$[1]'), JSON_REPLACE('{ \"a\": 1, \"b\": [2, 3]}', '$.a', 10, '$.c', '[true, false]'), JSON_SET('{ \"a\": 1, \"b\": [2, 3]}', '$.a', 10, '$.c', '[true, false]'), JSON_UNQUOTE('\"abc\"')",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select JSON_REMOVE('[1, [2, 3], 4]', '$[1]'), JSON_REPLACE('{ \"a\": 1, \"b\": [2, 3]}', '$.a', 10, '$.c', '[true, false]'), JSON_SET('{ \"a\": 1, \"b\": [2, 3]}', '$.a', 10, '$.c', '[true, false]'), JSON_UNQUOTE('\"abc\"')",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Reference",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select json_remove('[1, [2, 3], 4]', '$[1]'), json_replace('{ \\\"a\\\": 1, \\\"b\\\": [2, 3]}', '$.a', 10, '$.c', '[true, false]'), json_set('{ \\\"a\\\": 1, \\\"b\\\": [2, 3]}', '$.a', 10, '$.c', '[true, false]'), json_unquote('\\\"abc\\\"') from dual where 1 != 1",
        "Query": "select json_remove('[1, [2, 3], 4]', '$[1]'), json_replace('{ \\\"a\\\": 1, \\\"b\\\": [2, 3]}', '$.a', 10, '$.c', '[true, false]'), json_set('{ \\\"a\\\": 1, \\\"b\\\": [2, 3]}', '$.a', 10, '$.c', '[true, false]'), json_unquote('\\\"abc\\\"') from dual",
        "Table": "dual"
      },
      "TablesUsed": [
        "main.dual"
      ]
    }
  },
  {
    "comment": "insert function not requiring any table",
    "query": "select insert('Quadratic', 3, 4, 'What')",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select insert('Quadratic', 3, 4, 'What')",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Reference",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select insert('Quadratic', 3, 4, 'What') from dual where 1 != 1",
        "Query": "select insert('Quadratic', 3, 4, 'What') from dual",
        "Table": "dual"
      },
      "TablesUsed": [
        "main.dual"
      ]
    }
  },
  {
    "comment": "gtid functions",
    "query": "select gtid_subset('3E11FA47-71CA-11E1-9E33-C80AA9429562:23','3E11FA47-71CA-11E1-9E33-C80AA9429562:21-57'), gtid_subtract('3E11FA47-71CA-11E1-9E33-C80AA9429562:23','3E11FA47-71CA-11E1-9E33-C80AA9429562:21-57')",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select gtid_subset('3E11FA47-71CA-11E1-9E33-C80AA9429562:23','3E11FA47-71CA-11E1-9E33-C80AA9429562:21-57'), gtid_subtract('3E11FA47-71CA-11E1-9E33-C80AA9429562:23','3E11FA47-71CA-11E1-9E33-C80AA9429562:21-57')",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Reference",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select gtid_subset('3E11FA47-71CA-11E1-9E33-C80AA9429562:23', '3E11FA47-71CA-11E1-9E33-C80AA9429562:21-57'), gtid_subtract('3E11FA47-71CA-11E1-9E33-C80AA9429562:23', '3E11FA47-71CA-11E1-9E33-C80AA9429562:21-57') from dual where 1 != 1",
        "Query": "select gtid_subset('3E11FA47-71CA-11E1-9E33-C80AA9429562:23', '3E11FA47-71CA-11E1-9E33-C80AA9429562:21-57'), gtid_subtract('3E11FA47-71CA-11E1-9E33-C80AA9429562:23', '3E11FA47-71CA-11E1-9E33-C80AA9429562:21-57') from dual",
        "Table": "dual"
      },
      "TablesUsed": [
        "main.dual"
      ]
    }
  },
  {
    "comment": "Predicate in apply join which is merged",
    "query": "select user.col, user_metadata.user_id from user join user_extra on user.col = user_extra.col join user_metadata on user_extra.user_id = user_metadata.user_id where user.textcol1 = 'alice@gmail.com'",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select user.col, user_metadata.user_id from user join user_extra on user.col = user_extra.col join user_metadata on user_extra.user_id = user_metadata.user_id where user.textcol1 = 'alice@gmail.com'",
      "Instructions": {
        "OperatorType": "Join",
        "Variant": "Join",
        "JoinColumnIndexes": "L:0,R:0",
        "JoinVars": {
          "user_col": 0
        },
        "TableName": "`user`_user_extra, user_metadata",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select `user`.col from `user` where 1 != 1",
            "Query": "select `user`.col from `user` where `user`.textcol1 = 'alice@gmail.com'",
            "Table": "`user`"
          },
          {
            "OperatorType": "Route",
            "Variant": "Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select user_metadata.user_id from user_extra, user_metadata where 1 != 1",
            "Query": "select user_metadata.user_id from user_extra, user_metadata where user_extra.col = :user_col and user_extra.user_id = user_metadata.user_id",
            "Table": "user_extra, user_metadata"
          }
        ]
      },
      "TablesUsed": [
        "user.user",
        "user.user_extra",
        "user.user_metadata"
      ]
    }
  },
  {
    "comment": "Join across multiple tables, with conditions on different vindexes, but mergeable through join predicates",
    "query": "SELECT user.id FROM user INNER JOIN music_extra ON user.id = music_extra.user_id INNER JOIN music ON music_extra.user_id = music.user_id WHERE user.id = 123 and music.id = 456",
    "plan": {
      "QueryType": "SELECT",
      "Original": "SELECT user.id FROM user INNER JOIN music_extra ON user.id = music_extra.user_id INNER JOIN music ON music_extra.user_id = music.user_id WHERE user.id = 123 and music.id = 456",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "EqualUnique",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select `user`.id from `user`, music_extra, music where 1 != 1",
        "Query": "select `user`.id from `user`, music_extra, music where music.id = 456 and `user`.id = 123 and `user`.id = music_extra.user_id and music_extra.user_id = music.user_id",
        "Table": "`user`, music, music_extra",
        "Values": [
          "INT64(123)"
        ],
        "Vindex": "user_index"
      },
      "TablesUsed": [
        "user.music",
        "user.music_extra",
        "user.user"
      ]
    }
  },
  {
    "comment": "SQL_CALC_FOUND_ROWS with vindex lookup",
    "query": "select SQL_CALC_FOUND_ROWS id, name from user where name = 'aa' order by id limit 2",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select SQL_CALC_FOUND_ROWS id, name from user where name = 'aa' order by id limit 2",
      "Instructions": {
        "OperatorType": "SQL_CALC_FOUND_ROWS",
        "Inputs": [
          {
            "OperatorType": "Limit",
            "Count": "INT64(2)",
            "Inputs": [
              {
                "OperatorType": "VindexLookup",
                "Variant": "Equal",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "Values": [
                  "VARCHAR(\"aa\")"
                ],
                "Vindex": "name_user_map",
                "Inputs": [
                  {
                    "OperatorType": "Route",
                    "Variant": "IN",
                    "Keyspace": {
                      "Name": "user",
                      "Sharded": true
                    },
                    "FieldQuery": "select `name`, keyspace_id from name_user_vdx where 1 != 1",
                    "Query": "select `name`, keyspace_id from name_user_vdx where `name` in ::__vals",
                    "Table": "name_user_vdx",
                    "Values": [
                      "::name"
                    ],
                    "Vindex": "user_index"
                  },
                  {
                    "OperatorType": "Route",
                    "Variant": "ByDestination",
                    "Keyspace": {
                      "Name": "user",
                      "Sharded": true
                    },
                    "FieldQuery": "select id, `name`, weight_string(id) from `user` where 1 != 1",
                    "OrderBy": "(0|2) ASC",
                    "Query": "select id, `name`, weight_string(id) from `user` where `name` = 'aa' order by id asc limit :__upper_limit",
                    "ResultColumns": 2,
                    "Table": "`user`"
                  }
                ]
              }
            ]
          },
          {
            "OperatorType": "Aggregate",
            "Variant": "Scalar",
            "Aggregates": "sum_count_star(0) AS count(*)",
            "Inputs": [
              {
                "OperatorType": "VindexLookup",
                "Variant": "Equal",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "Values": [
                  "VARCHAR(\"aa\")"
                ],
                "Vindex": "name_user_map",
                "Inputs": [
                  {
                    "OperatorType": "Route",
                    "Variant": "IN",
                    "Keyspace": {
                      "Name": "user",
                      "Sharded": true
                    },
                    "FieldQuery": "select `name`, keyspace_id from name_user_vdx where 1 != 1",
                    "Query": "select `name`, keyspace_id from name_user_vdx where `name` in ::__vals",
                    "Table": "name_user_vdx",
                    "Values": [
                      "::name"
                    ],
                    "Vindex": "user_index"
                  },
                  {
                    "OperatorType": "Route",
                    "Variant": "ByDestination",
                    "Keyspace": {
                      "Name": "user",
                      "Sharded": true
                    },
                    "FieldQuery": "select count(*) from `user` where 1 != 1",
                    "Query": "select count(*) from `user` where `name` = 'aa'",
                    "Table": "`user`"
                  }
                ]
              }
            ]
          }
        ]
      },
      "TablesUsed": [
        "user.user"
      ]
    }
  },
  {
    "comment": "`None` route being merged with another route via join predicate on Vindex columns",
    "query": "SELECT `music`.id FROM `music` INNER JOIN `user` ON music.user_id = user.id WHERE music.user_id IN (NULL) AND user.id = 5",
    "plan": {
      "QueryType": "SELECT",
      "Original": "SELECT `music`.id FROM `music` INNER JOIN `user` ON music.user_id = user.id WHERE music.user_id IN (NULL) AND user.id = 5",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "None",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select music.id from music, `user` where 1 != 1",
        "Query": "select music.id from music, `user` where music.user_id in (null) and `user`.id = 5 and music.user_id = `user`.id",
        "Table": "`user`, music"
      },
      "TablesUsed": [
        "user.music",
        "user.user"
      ]
    }
  },
  {
    "comment": "Treating single value tuples as `EqualUnique` routes",
    "query": "SELECT music.id FROM music WHERE music.id IN (SELECT music.id FROM music WHERE music.user_id IN (5)) AND music.user_id = 5",
    "plan": {
      "QueryType": "SELECT",
      "Original": "SELECT music.id FROM music WHERE music.id IN (SELECT music.id FROM music WHERE music.user_id IN (5)) AND music.user_id = 5",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "EqualUnique",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select music.id from music where 1 != 1",
        "Query": "select music.id from music where music.id in (select music.id from music where music.user_id in (5)) and music.user_id = 5",
        "Table": "music",
        "Values": [
          "INT64(5)"
        ],
        "Vindex": "user_index"
      },
      "TablesUsed": [
        "user.music"
      ]
    }
  },
  {
    "comment": "limit on the vtgate has to be executed on the LHS of a join",
    "query": "select id from user join (select user_id from user_extra limit 10) ue on user.id = ue.user_id",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select id from user join (select user_id from user_extra limit 10) ue on user.id = ue.user_id",
      "Instructions": {
        "OperatorType": "Join",
        "Variant": "Join",
        "JoinColumnIndexes": "R:0",
        "JoinVars": {
          "ue_user_id": 0
        },
        "TableName": "user_extra_`user`",
        "Inputs": [
          {
            "OperatorType": "Limit",
            "Count": "INT64(10)",
            "Inputs": [
              {
                "OperatorType": "Route",
                "Variant": "Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select user_id from (select user_id from user_extra where 1 != 1) as ue where 1 != 1",
                "Query": "select user_id from (select user_id from user_extra) as ue limit :__upper_limit",
                "Table": "user_extra"
              }
            ]
          },
          {
            "OperatorType": "Route",
            "Variant": "EqualUnique",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select id from `user` where 1 != 1",
            "Query": "select id from `user` where `user`.id = :ue_user_id",
            "Table": "`user`",
            "Values": [
              ":ue_user_id"
            ],
            "Vindex": "user_index"
          }
        ]
      },
      "TablesUsed": [
        "user.user",
        "user.user_extra"
      ]
    }
  },
  {
    "comment": "select user.a, t.b from user join (select id, count(*) b, req from user_extra group by req, id) as t on user.id = t.id",
    "query": "select user.a, t.b from user join (select id, count(*) b, req from user_extra group by req, id) as t on user.id = t.id",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select user.a, t.b from user join (select id, count(*) b, req from user_extra group by req, id) as t on user.id = t.id",
      "Instructions": {
        "OperatorType": "Join",
        "Variant": "Join",
        "JoinColumnIndexes": "R:0,L:0",
        "JoinVars": {
          "t_id": 1
        },
        "TableName": "user_extra_`user`",
        "Inputs": [
          {
            "OperatorType": "SimpleProjection",
            "Columns": [
              1,
              0
            ],
            "Inputs": [
              {
                "OperatorType": "Aggregate",
                "Variant": "Ordered",
                "Aggregates": "sum_count_star(1) AS b",
                "GroupBy": "(2|3), (0|4)",
                "Inputs": [
                  {
                    "OperatorType": "Route",
                    "Variant": "Scatter",
                    "Keyspace": {
                      "Name": "user",
                      "Sharded": true
                    },
                    "FieldQuery": "select id, count(*) as b, req, weight_string(req), weight_string(id) from user_extra where 1 != 1 group by req, id, weight_string(req), weight_string(id)",
                    "OrderBy": "(2|3) ASC, (0|4) ASC",
                    "Query": "select id, count(*) as b, req, weight_string(req), weight_string(id) from user_extra group by req, id, weight_string(req), weight_string(id) order by req asc, id asc",
                    "Table": "user_extra"
                  }
                ]
              }
            ]
          },
          {
            "OperatorType": "Route",
            "Variant": "EqualUnique",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select `user`.a from `user` where 1 != 1",
            "Query": "select `user`.a from `user` where `user`.id = :t_id",
            "Table": "`user`",
            "Values": [
              ":t_id"
            ],
            "Vindex": "user_index"
          }
        ]
      },
      "TablesUsed": [
        "user.user",
        "user.user_extra"
      ]
    }
  },
  {
    "comment": "SELECT music.id FROM (SELECT MAX(id) as maxt FROM music WHERE music.user_id = 5) other JOIN music ON other.maxt = music.id",
    "query": "SELECT music.id FROM (SELECT MAX(id) as maxt FROM music WHERE music.user_id = 5) other JOIN music ON other.maxt = music.id",
    "plan": {
      "QueryType": "SELECT",
      "Original": "SELECT music.id FROM (SELECT MAX(id) as maxt FROM music WHERE music.user_id = 5) other JOIN music ON other.maxt = music.id",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "EqualUnique",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select music.id from (select max(id) as maxt from music where 1 != 1) as other, music where 1 != 1",
        "Query": "select music.id from (select max(id) as maxt from music where music.user_id = 5) as other, music where other.maxt = music.id",
        "Table": "music",
        "Values": [
          "INT64(5)"
        ],
        "Vindex": "user_index"
      },
      "TablesUsed": [
        "user.music"
      ]
    }
  },
  {
    "comment": "query with a derived table and dual table in unsharded keyspace",
    "query": "SELECT * FROM unsharded_a AS t1  JOIN (SELECT trim((SELECT MAX(name) FROM unsharded_a)) AS name) AS t2 WHERE t1.name >= t2.name ORDER BY t1.name ASC LIMIT 1;",
    "plan": {
      "QueryType": "SELECT",
      "Original": "SELECT * FROM unsharded_a AS t1  JOIN (SELECT trim((SELECT MAX(name) FROM unsharded_a)) AS name) AS t2 WHERE t1.name >= t2.name ORDER BY t1.name ASC LIMIT 1;",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Unsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select * from unsharded_a as t1 join (select trim((select max(`name`) from unsharded_a where 1 != 1)) as `name` from dual where 1 != 1) as t2 where 1 != 1",
        "Query": "select * from unsharded_a as t1 join (select trim((select max(`name`) from unsharded_a)) as `name` from dual) as t2 where t1.`name` >= t2.`name` order by t1.`name` asc limit 1",
        "Table": "dual, unsharded_a"
      },
      "TablesUsed": [
        "main.dual",
        "main.unsharded_a"
      ]
    }
  },
  {
    "comment": "Query with non-plannable lookup vindex",
    "query": "SELECT * FROM user_metadata WHERE user_metadata.non_planable = 'foo'",
    "plan": {
      "QueryType": "SELECT",
      "Original": "SELECT * FROM user_metadata WHERE user_metadata.non_planable = 'foo'",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Equal",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select * from user_metadata where 1 != 1",
        "Query": "select * from user_metadata where user_metadata.non_planable = 'foo'",
        "Table": "user_metadata",
        "Values": [
          "VARCHAR(\"foo\")"
        ],
        "Vindex": "non_planable_user_map"
      },
      "TablesUsed": [
        "user.user_metadata"
      ]
    }
  },
  {
    "comment": "join query with lookup and join on different vindex column",
    "query": "select u.id from user u, user_metadata um where u.name = 'foo' and u.id = um.user_id",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select u.id from user u, user_metadata um where u.name = 'foo' and u.id = um.user_id",
      "Instructions": {
        "OperatorType": "VindexLookup",
        "Variant": "Equal",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "Values": [
          "VARCHAR(\"foo\")"
        ],
        "Vindex": "name_user_map",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "IN",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select `name`, keyspace_id from name_user_vdx where 1 != 1",
            "Query": "select `name`, keyspace_id from name_user_vdx where `name` in ::__vals",
            "Table": "name_user_vdx",
            "Values": [
              "::name"
            ],
            "Vindex": "user_index"
          },
          {
            "OperatorType": "Route",
            "Variant": "ByDestination",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select u.id from `user` as u, user_metadata as um where 1 != 1",
            "Query": "select u.id from `user` as u, user_metadata as um where u.`name` = 'foo' and u.id = um.user_id",
            "Table": "`user`, user_metadata"
          }
        ]
      },
      "TablesUsed": [
        "user.user",
        "user.user_metadata"
      ]
    }
  },
  {
    "comment": "pick email as vindex lookup",
    "query": "select * from customer where email = 'a@mail.com'",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select * from customer where email = 'a@mail.com'",
      "Instructions": {
        "OperatorType": "VindexLookup",
        "Variant": "Equal",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "Values": [
          "VARCHAR(\"a@mail.com\")"
        ],
        "Vindex": "unq_lkp_vdx",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "IN",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select unq_key, keyspace_id from unq_lkp_idx where 1 != 1",
            "Query": "select unq_key, keyspace_id from unq_lkp_idx where unq_key in ::__vals",
            "Table": "unq_lkp_idx",
            "Values": [
              "::unq_key"
            ],
            "Vindex": "shard_index"
          },
          {
            "OperatorType": "Route",
            "Variant": "ByDestination",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select * from customer where 1 != 1",
            "Query": "select * from customer where email = 'a@mail.com'",
            "Table": "customer"
          }
        ]
      },
      "TablesUsed": [
        "user.customer"
      ]
    }
  },
  {
    "comment": "phone is in backfill vindex - not selected for vindex lookup",
    "query": "select * from customer where phone = 123456",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select * from customer where phone = 123456",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Scatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select * from customer where 1 != 1",
        "Query": "select * from customer where phone = 123456",
        "Table": "customer"
      },
      "TablesUsed": [
        "user.customer"
      ]
    }
  },
  {
    "comment": "email vindex is costly than phone vindex - but phone vindex is backfiling hence ignored",
    "query": "select * from customer where email = 'a@mail.com' and phone = 123456",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select * from customer where email = 'a@mail.com' and phone = 123456",
      "Instructions": {
        "OperatorType": "VindexLookup",
        "Variant": "Equal",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "Values": [
          "VARCHAR(\"a@mail.com\")"
        ],
        "Vindex": "unq_lkp_vdx",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "IN",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select unq_key, keyspace_id from unq_lkp_idx where 1 != 1",
            "Query": "select unq_key, keyspace_id from unq_lkp_idx where unq_key in ::__vals",
            "Table": "unq_lkp_idx",
            "Values": [
              "::unq_key"
            ],
            "Vindex": "shard_index"
          },
          {
            "OperatorType": "Route",
            "Variant": "ByDestination",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select * from customer where 1 != 1",
            "Query": "select * from customer where email = 'a@mail.com' and phone = 123456",
            "Table": "customer"
          }
        ]
      },
      "TablesUsed": [
        "user.customer"
      ]
    }
  },
  {
    "comment": "predicate order changed: email vindex is costly than phone vindex - but phone vindex is backfiling hence ignored",
    "query": "select * from customer where phone = 123456 and email = 'a@mail.com'",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select * from customer where phone = 123456 and email = 'a@mail.com'",
      "Instructions": {
        "OperatorType": "VindexLookup",
        "Variant": "Equal",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "Values": [
          "VARCHAR(\"a@mail.com\")"
        ],
        "Vindex": "unq_lkp_vdx",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "IN",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select unq_key, keyspace_id from unq_lkp_idx where 1 != 1",
            "Query": "select unq_key, keyspace_id from unq_lkp_idx where unq_key in ::__vals",
            "Table": "unq_lkp_idx",
            "Values": [
              "::unq_key"
            ],
            "Vindex": "shard_index"
          },
          {
            "OperatorType": "Route",
            "Variant": "ByDestination",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select * from customer where 1 != 1",
            "Query": "select * from customer where phone = 123456 and email = 'a@mail.com'",
            "Table": "customer"
          }
        ]
      },
      "TablesUsed": [
        "user.customer"
      ]
    }
  },
  {
    "comment": "Merging dual with user",
    "query": "select 42, id from dual, t_user",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select 42, id from dual, t_user",
      "Instructions": {
        "OperatorType": "Route",
        "Variant": "Scatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select 42, id from dual, t_user where 1 != 1",
        "Query": "select 42, id from dual, t_user",
        "Table": "dual, t_user"
      },
      "TablesUsed": [
        "main.dual",
        "user.t_user"
      ]
    }
  },
  {
    "comment": "Derived tables going to a single shard still need to expand derived table columns",
    "query": "SELECT c.column_name FROM user c JOIN (SELECT table_name FROM unsharded LIMIT 1) AS tables ON tables.table_name = c.table_name",
    "plan": {
      "QueryType": "SELECT",
      "Original": "SELECT c.column_name FROM user c JOIN (SELECT table_name FROM unsharded LIMIT 1) AS tables ON tables.table_name = c.table_name",
      "Instructions": {
        "OperatorType": "Join",
        "Variant": "Join",
        "JoinColumnIndexes": "R:0",
        "JoinVars": {
          "tables_table_name": 0
        },
        "TableName": "unsharded_`user`",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "Unsharded",
            "Keyspace": {
              "Name": "main",
              "Sharded": false
            },
            "FieldQuery": "select table_name from (select table_name from unsharded where 1 != 1) as `tables` where 1 != 1",
            "Query": "select table_name from (select table_name from unsharded limit 1) as `tables`",
            "Table": "unsharded"
          },
          {
            "OperatorType": "Route",
            "Variant": "Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select c.column_name from `user` as c where 1 != 1",
            "Query": "select c.column_name from `user` as c where c.table_name = :tables_table_name",
            "Table": "`user`"
          }
        ]
      },
      "TablesUsed": [
        "main.unsharded",
        "user.user"
      ]
    }
  }
]
