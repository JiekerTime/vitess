[
  {
    "comment": "select (select col from t_user limit 1) as a from t_user join t_user_extra order by a",
    "query": "select (select col from t_user limit 1) as a from t_user join t_user_extra order by a",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select (select col from t_user limit 1) as a from t_user join t_user_extra order by a",
      "Instructions": {
        "OperatorType": "Join",
        "Variant": "Join",
        "JoinColumnIndexes": "L:0",
        "TableName": "t_user_t_user_extra",
        "Inputs": [
          {
            "OperatorType": "UncorrelatedSubquery",
            "Variant": "PulloutValue",
            "PulloutVars": [
              "__sq1"
            ],
            "Inputs": [
              {
                "InputName": "SubQuery",
                "OperatorType": "Limit",
                "Count": "INT64(1)",
                "Inputs": [
                  {
                    "OperatorType": "TableRoute",
                    "Variant": "Scatter-Scatter",
                    "Keyspace": {
                      "Name": "user",
                      "Sharded": true
                    },
                    "FieldQuery": "select col from t_user_0 where 1 != 1",
                    "Query": "select col from t_user limit :__upper_limit",
                    "Table": "t_user"
                  }
                ]
              },
              {
                "InputName": "Outer",
                "OperatorType": "TableRoute",
                "Variant": "Scatter-Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select :__sq1 as a, weight_string(:__sq1) from t_user_0 where 1 != 1",
                "OrderBy": "(0|1) ASC",
                "Query": "select :__sq1 as a, weight_string(:__sq1) from t_user order by a asc",
                "Table": "t_user"
              }
            ]
          },
          {
            "OperatorType": "TableRoute",
            "Variant": "Scatter-Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select 1 from t_user_extra_0 where 1 != 1",
            "Query": "select 1 from t_user_extra",
            "Table": "t_user_extra"
          }
        ]
      },
      "TablesUsed": [
        "user.t_user",
        "user.t_user_extra"
      ]
    }
  },
  {
    "comment": "select (select id from t_user order by id limit 1) from t_user_extra",
    "query": "select (select id from t_user order by id limit 1) from t_user_extra",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select (select id from t_user order by id limit 1) from t_user_extra",
      "Instructions": {
        "OperatorType": "UncorrelatedSubquery",
        "Variant": "PulloutValue",
        "PulloutVars": [
          "__sq1"
        ],
        "Inputs": [
          {
            "InputName": "SubQuery",
            "OperatorType": "Limit",
            "Count": "INT64(1)",
            "Inputs": [
              {
                "OperatorType": "TableRoute",
                "Variant": "Scatter-Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select id, weight_string(id) from t_user_0 where 1 != 1",
                "OrderBy": "(0|1) ASC",
                "Query": "select id, weight_string(id) from t_user order by id asc limit :__upper_limit",
                "Table": "t_user"
              }
            ]
          },
          {
            "InputName": "Outer",
            "OperatorType": "TableRoute",
            "Variant": "Scatter-Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select :__sq1 as `(select id from t_user order by id asc limit 1)` from t_user_extra_0 where 1 != 1",
            "Query": "select :__sq1 as `(select id from t_user order by id asc limit 1)` from t_user_extra",
            "Table": "t_user_extra"
          }
        ]
      },
      "TablesUsed": [
        "user.t_user",
        "user.t_user_extra"
      ]
    }
  },
  {
    "comment": "Subquery with `IN` condition using columns with matching lookup vindexes",
    "query": "SELECT t_music.id FROM t_music WHERE t_music.id IN (SELECT t_music.id FROM t_music WHERE t_music.user_id IN (1, 2, 3))",
    "plan": "VT12001: unsupported: subquery in split table"
  },
  {
    "comment": "Subquery with `IN` condition using columns with matching lookup vindexes, with derived table",
    "query": "SELECT t_music.id FROM t_music WHERE t_music.id IN (SELECT * FROM (SELECT t_music.id FROM t_music WHERE t_music.user_id IN (1, 2, 3)) _inner)",
    "plan": "VT12001: unsupported: subquery in split table"
  },
  {
    "comment": "Subquery with `IN` condition using columns with matching lookup vindexes, with inner scatter query",
    "query": "SELECT t_music.id FROM t_music WHERE t_music.id IN (SELECT t_music.id FROM t_music WHERE t_music.foo = 'bar') AND t_music.user_id IN (3, 4, 5)",
    "plan": "VT12001: unsupported: subquery in split table"
  },
  {
    "comment": "Subquery with `IN` condition using columns with matching lookup vindexes",
    "query": "SELECT t_music.id FROM t_music WHERE t_music.id IN (SELECT t_music.id FROM t_music WHERE t_music.user_id IN (1, 2, 3)) and t_music.user_id = 5",
    "plan": "VT12001: unsupported: subquery in split table"
  },
  {
    "comment": "Subquery with `IN` condition using columns with matching lookup vindexes, but not a top level predicate",
    "query": "SELECT t_music.id FROM t_music WHERE t_music.id IN (SELECT t_music.id FROM t_music WHERE t_music.user_id IN (1, 2, 3)) OR t_music.user_id = 5",
    "plan": "VT12001: unsupported: subquery in split table"
  },
  {
    "comment": "`IN` comparison on Vindex with `None` subquery, as routing predicate",
    "query": "SELECT `t_music`.id FROM `t_music` WHERE t_music.id IN (SELECT t_music.id FROM t_music WHERE t_music.user_id IN (NULL)) AND t_music.user_id = 5",
    "plan": "VT12001: unsupported: subquery in split table"
  },
  {
    "comment": "`IN` comparison on Vindex with `None` subquery, as non-routing predicate",
    "query": "SELECT `t_music`.id FROM `t_music` WHERE t_music.id IN (SELECT t_music.id FROM t_music WHERE t_music.user_id IN (NULL)) OR t_music.user_id = 5",
    "plan": "VT12001: unsupported: subquery in split table"
  },
  {
    "comment": "Mergeable scatter subquery",
    "query": "SELECT t_music.id FROM t_music WHERE t_music.id IN (SELECT t_music.id FROM t_music WHERE t_music.genre = 'pop')",
    "plan": "VT12001: unsupported: subquery in split table"
  },
  {
    "comment": "Mergeable scatter subquery with `GROUP BY` on unique vindex column",
    "query": "SELECT t_music.id FROM t_music WHERE t_music.id IN (SELECT t_music.id FROM t_music WHERE t_music.genre = 'pop' GROUP BY t_music.id)",
    "plan": "VT12001: unsupported: subquery in split table"
  },
  {
    "comment": "Unmergeable scatter subquery with LIMIT",
    "query": "SELECT t_music.id FROM t_music WHERE t_music.id IN (SELECT t_music.id FROM t_music WHERE t_music.genre = 'pop' LIMIT 10)",
    "plan": {
      "QueryType": "SELECT",
      "Original": "SELECT t_music.id FROM t_music WHERE t_music.id IN (SELECT t_music.id FROM t_music WHERE t_music.genre = 'pop' LIMIT 10)",
      "Instructions": {
        "OperatorType": "UncorrelatedSubquery",
        "Variant": "PulloutIn",
        "PulloutVars": [
          "__sq_has_values",
          "__sq1"
        ],
        "Inputs": [
          {
            "InputName": "SubQuery",
            "OperatorType": "Limit",
            "Count": "INT64(10)",
            "Inputs": [
              {
                "OperatorType": "TableRoute",
                "Variant": "Scatter-Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select t_music_0.id from t_music_0 where 1 != 1",
                "Query": "select t_music.id from t_music where t_music.genre = 'pop' limit :__upper_limit",
                "Table": "t_music"
              }
            ]
          },
          {
            "InputName": "Outer",
            "OperatorType": "TableRoute",
            "Variant": "IN-Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select t_music_0.id from t_music_0 where 1 != 1",
            "Query": "select t_music.id from t_music where t_music.id in ::__vals and :__sq_has_values",
            "Table": "t_music",
            "Values": [
              "::__sq1"
            ],
            "Vindex": "music_user_map"
          }
        ]
      },
      "TablesUsed": [
        "user.t_music"
      ]
    }
  },
  {
    "comment": "Unmergeable scatter subquery with `GROUP BY` on-non vindex column",
    "query": "SELECT t_music.id FROM t_music WHERE t_music.id IN (SELECT t_music.id FROM t_music WHERE t_music.genre = 'pop' GROUP BY t_music.genre)",
    "plan": {
      "QueryType": "SELECT",
      "Original": "SELECT t_music.id FROM t_music WHERE t_music.id IN (SELECT t_music.id FROM t_music WHERE t_music.genre = 'pop' GROUP BY t_music.genre)",
      "Instructions": {
        "OperatorType": "UncorrelatedSubquery",
        "Variant": "PulloutIn",
        "PulloutVars": [
          "__sq_has_values",
          "__sq1"
        ],
        "Inputs": [
          {
            "InputName": "SubQuery",
            "OperatorType": "Aggregate",
            "Variant": "Ordered",
            "Aggregates": "any_value(0) AS id",
            "GroupBy": "(1|2)",
            "Inputs": [
              {
                "OperatorType": "TableRoute",
                "Variant": "Scatter-Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select t_music_0.id, t_music_0.genre, weight_string(t_music_0.genre) from t_music_0 where 1 != 1 group by t_music_0.genre, weight_string(t_music_0.genre)",
                "OrderBy": "(1|2) ASC",
                "Query": "select t_music.id, t_music.genre, weight_string(t_music.genre) from t_music where t_music.genre = 'pop' group by t_music.genre, weight_string(t_music.genre) order by t_music.genre asc",
                "Table": "t_music"
              }
            ]
          },
          {
            "InputName": "Outer",
            "OperatorType": "TableRoute",
            "Variant": "IN-Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select t_music_0.id from t_music_0 where 1 != 1",
            "Query": "select t_music.id from t_music where t_music.id in ::__vals and :__sq_has_values",
            "Table": "t_music",
            "Values": [
              "::__sq1"
            ],
            "Vindex": "music_user_map"
          }
        ]
      },
      "TablesUsed": [
        "user.t_music"
      ]
    }
  },
  {
    "comment": "Mergeable subquery with multiple levels of derived statements",
    "query": "SELECT t_music.id FROM t_music WHERE t_music.id IN (SELECT * FROM (SELECT * FROM (SELECT t_music.id FROM t_music WHERE t_music.user_id = 5 LIMIT 10) subquery_for_limit) subquery_for_limit)",
    "plan": "VT12001: unsupported: subquery in split table"
  },
  {
    "comment": "Mergeable subquery with multiple levels of derived statements, using a single value `IN` predicate",
    "query": "SELECT t_music.id FROM t_music WHERE t_music.id IN (SELECT * FROM (SELECT * FROM (SELECT t_music.id FROM t_music WHERE t_music.user_id IN (5) LIMIT 10) subquery_for_limit) subquery_for_limit)",
    "plan": "VT12001: unsupported: subquery in split table"
  },
  {
    "comment": "`None` subquery as top level predicate - outer query changes from `Scatter` to `None` on merge",
    "query": "SELECT t_music.id FROM t_music WHERE t_music.id IN (SELECT t_music.id FROM t_music WHERE t_music.user_id IN (NULL))",
    "plan": "VT12001: unsupported: subquery in split table"
  },
  {
    "comment": "`None` subquery as top level predicate - outer query changes from `EqualUnique` to `None` on merge",
    "query": "SELECT t_music.id FROM t_music WHERE t_music.id IN (SELECT t_music.id FROM t_music WHERE t_music.user_id IN (NULL)) AND t_music.user_id = 5",
    "plan": "VT12001: unsupported: subquery in split table"
  },
  {
    "comment": "`None` subquery nested inside `OR` expression - outer query keeps routing information",
    "query": "SELECT t_music.id FROM t_music WHERE (t_music.id IN (SELECT t_music.id FROM t_music WHERE t_music.user_id IN (NULL)) OR t_music.user_id = 5)",
    "plan": "VT12001: unsupported: subquery in split table"
  },
  {
    "comment": "subquery having join table on clause, using column reference of outer select table",
    "query": "select (select 1 from t_user u1 join t_user u2 on u1.id = u2.id and u1.id = u3.id) subquery from t_user u3 where u3.id = 1",
    "plan": "VT12001: unsupported: subquery in split table"
  },
  {
    "comment": "Reference with a subquery which cannot be merged",
    "query": "select exists(select * from t_user)",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select exists(select * from t_user)",
      "Instructions": {
        "OperatorType": "UncorrelatedSubquery",
        "Variant": "PulloutExists",
        "PulloutVars": [
          "__sq_has_values2",
          "__sq1"
        ],
        "Inputs": [
          {
            "InputName": "SubQuery",
            "OperatorType": "TableRoute",
            "Variant": "Scatter-Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select 1 from t_user_0 where 1 != 1",
            "Query": "select 1 from t_user",
            "Table": "t_user"
          },
          {
            "InputName": "Outer",
            "OperatorType": "Route",
            "Variant": "Reference",
            "Keyspace": {
              "Name": "main",
              "Sharded": false
            },
            "FieldQuery": "select :__sq_has_values2 as `exists (select 1 from t_user)` from dual where 1 != 1",
            "Query": "select :__sq_has_values2 as `exists (select 1 from t_user)` from dual",
            "Table": "dual"
          }
        ]
      },
      "TablesUsed": [
        "user.dual",
        "user.t_user"
      ]
    }
  },
  {
    "comment": "Unmergeable subquery with `MAX` aggregate",
    "query": "SELECT t_music.id FROM t_music WHERE t_music.id IN (SELECT MAX(t_music.id) FROM t_music WHERE t_music.user_id IN (5, 6))",
    "plan": {
      "QueryType": "SELECT",
      "Original": "SELECT t_music.id FROM t_music WHERE t_music.id IN (SELECT MAX(t_music.id) FROM t_music WHERE t_music.user_id IN (5, 6))",
      "Instructions": {
        "OperatorType": "UncorrelatedSubquery",
        "Variant": "PulloutIn",
        "PulloutVars": [
          "__sq_has_values",
          "__sq1"
        ],
        "Inputs": [
          {
            "InputName": "SubQuery",
            "OperatorType": "Aggregate",
            "Variant": "Scalar",
            "Aggregates": "max(0|1) AS max(t_music.id)",
            "Inputs": [
              {
                "OperatorType": "TableRoute",
                "Variant": "IN-Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select max(t_music_0.id), weight_string(t_music_0.id) from t_music_0 where 1 != 1 group by weight_string(t_music_0.id)",
                "Query": "select max(t_music.id), weight_string(t_music.id) from t_music where t_music.user_id in ::__vals group by weight_string(t_music.id)",
                "Table": "t_music",
                "Values": [
                  "(INT64(5), INT64(6))"
                ],
                "Vindex": "user_index"
              }
            ]
          },
          {
            "InputName": "Outer",
            "OperatorType": "TableRoute",
            "Variant": "IN-Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select t_music_0.id from t_music_0 where 1 != 1",
            "Query": "select t_music.id from t_music where t_music.id in ::__vals and :__sq_has_values",
            "Table": "t_music",
            "Values": [
              "::__sq1"
            ],
            "Vindex": "music_user_map"
          }
        ]
      },
      "TablesUsed": [
        "user.t_music"
      ]
    }
  },
  {
    "comment": "Mergeable subquery with `MAX` aggregate with `EqualUnique` route operator",
    "query": "SELECT t_music.id FROM t_music WHERE t_music.id IN (SELECT MAX(t_music.id) FROM t_music WHERE t_music.user_id = 5)",
    "plan": {
      "QueryType": "SELECT",
      "Original": "SELECT t_music.id FROM t_music WHERE t_music.id IN (SELECT MAX(t_music.id) FROM t_music WHERE t_music.user_id = 5)",
      "Instructions": {
        "OperatorType": "UncorrelatedSubquery",
        "Variant": "PulloutIn",
        "PulloutVars": [
          "__sq_has_values",
          "__sq1"
        ],
        "Inputs": [
          {
            "InputName": "SubQuery",
            "OperatorType": "Aggregate",
            "Variant": "Scalar",
            "Aggregates": "max(0|1) AS max(t_music.id)",
            "ResultColumns": 1,
            "Inputs": [
              {
                "OperatorType": "TableRoute",
                "Variant": "EqualUnique-Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select max(t_music_0.id), weight_string(t_music_0.id) from t_music_0 where 1 != 1 group by weight_string(t_music_0.id)",
                "Query": "select max(t_music.id), weight_string(t_music.id) from t_music where t_music.user_id = 5 group by weight_string(t_music.id)",
                "Table": "t_music",
                "Values": [
                  "INT64(5)"
                ],
                "Vindex": "user_index"
              }
            ]
          },
          {
            "InputName": "Outer",
            "OperatorType": "TableRoute",
            "Variant": "IN-Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select t_music_0.id from t_music_0 where 1 != 1",
            "Query": "select t_music.id from t_music where t_music.id in ::__vals and :__sq_has_values",
            "Table": "t_music",
            "Values": [
              "::__sq1"
            ],
            "Vindex": "music_user_map"
          }
        ]
      },
      "TablesUsed": [
        "user.t_music"
      ]
    }
    },
  {
    "comment": "Mergeable subquery with `LIMIT` due to `EqualUnique` route",
    "query": "SELECT t_music.id FROM t_music WHERE t_music.id IN (SELECT MAX(t_music.id) FROM t_music WHERE t_music.user_id = 5 LIMIT 10)",
    "plan": {
      "QueryType": "SELECT",
      "Original": "SELECT t_music.id FROM t_music WHERE t_music.id IN (SELECT MAX(t_music.id) FROM t_music WHERE t_music.user_id = 5 LIMIT 10)",
      "Instructions": {
        "OperatorType": "UncorrelatedSubquery",
        "Variant": "PulloutIn",
        "PulloutVars": [
          "__sq_has_values",
          "__sq1"
        ],
        "Inputs": [
          {
            "InputName": "SubQuery",
            "OperatorType": "Limit",
            "Count": "INT64(10)",
            "Inputs": [
              {
                "OperatorType": "Aggregate",
                "Variant": "Scalar",
                "Aggregates": "max(0|1) AS max(t_music.id)",
                "ResultColumns": 1,
                "Inputs": [
                  {
                    "OperatorType": "TableRoute",
                    "Variant": "EqualUnique-Scatter",
                    "Keyspace": {
                      "Name": "user",
                      "Sharded": true
                    },
                    "FieldQuery": "select max(t_music_0.id), weight_string(t_music_0.id) from t_music_0 where 1 != 1 group by weight_string(t_music_0.id)",
                    "Query": "select max(t_music.id), weight_string(t_music.id) from t_music where t_music.user_id = 5 group by weight_string(t_music.id)",
                    "Table": "t_music",
                    "Values": [
                      "INT64(5)"
                    ],
                    "Vindex": "user_index"
                  }
                ]
              }
            ]
          },
          {
            "InputName": "Outer",
            "OperatorType": "TableRoute",
            "Variant": "IN-Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select t_music_0.id from t_music_0 where 1 != 1",
            "Query": "select t_music.id from t_music where t_music.id in ::__vals and :__sq_has_values",
            "Table": "t_music",
            "Values": [
              "::__sq1"
            ],
            "Vindex": "music_user_map"
          }
        ]
      },
      "TablesUsed": [
        "user.t_music"
      ]
    }
  },
  {
    "comment": "subquery with aggregate and outer with outer order route",
    "query": "select textcol1 from t_user where id> (select max(intcol) from t_user) ORDER BY intcol DESC",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select textcol1 from t_user where id> (select max(intcol) from t_user) ORDER BY intcol DESC",
      "Instructions": {
        "OperatorType": "UncorrelatedSubquery",
        "Variant": "PulloutValue",
        "PulloutVars": [
          "__sq1"
        ],
        "Inputs": [
          {
            "InputName": "SubQuery",
            "OperatorType": "Aggregate",
            "Variant": "Scalar",
            "Aggregates": "max(0) AS max(intcol)",
            "Inputs": [
              {
                "OperatorType": "TableRoute",
                "Variant": "Scatter-Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select max(intcol) from t_user_0 where 1 != 1",
                "Query": "select max(intcol) from t_user",
                "Table": "t_user"
              }
            ]
          },
          {
            "InputName": "Outer",
            "OperatorType": "TableRoute",
            "Variant": "Scatter-Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select textcol1, intcol from t_user_0 where 1 != 1",
            "OrderBy": "1 DESC",
            "Query": "select textcol1, intcol from t_user where id > :__sq1 order by intcol desc",
            "ResultColumns": 1,
            "Table": "t_user"
          }
        ]
      },
      "TablesUsed": [
        "user.t_user"
      ]
    }
  },
  {
    "comment": "scar subquery in select expressions",
    "query": "select textcol1,(select intcol from t_user limit 1) from t_user  ORDER BY intcol DESC",
    "plan": {
      "QueryType": "SELECT",
      "Original": "select textcol1,(select intcol from t_user limit 1) from t_user  ORDER BY intcol DESC",
      "Instructions": {
        "OperatorType": "UncorrelatedSubquery",
        "Variant": "PulloutValue",
        "PulloutVars": [
          "__sq1"
        ],
        "Inputs": [
          {
            "InputName": "SubQuery",
            "OperatorType": "Limit",
            "Count": "INT64(1)",
            "Inputs": [
              {
                "OperatorType": "TableRoute",
                "Variant": "Scatter-Scatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select intcol from t_user_0 where 1 != 1",
                "Query": "select intcol from t_user limit :__upper_limit",
                "Table": "t_user"
              }
            ]
          },
          {
            "InputName": "Outer",
            "OperatorType": "TableRoute",
            "Variant": "Scatter-Scatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select textcol1, :__sq1 as `(select intcol from t_user limit 1)`, intcol from t_user_0 where 1 != 1",
            "OrderBy": "2 DESC",
            "Query": "select textcol1, :__sq1 as `(select intcol from t_user limit 1)`, intcol from t_user order by intcol desc",
            "ResultColumns": 2,
            "Table": "t_user"
          }
        ]
      },
      "TablesUsed": [
        "user.t_user"
      ]
    }
  }
]
